<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - AquaSphere</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Shared Navbar CSS - Load early -->
    <link rel="stylesheet" href="navbar.css">
    
    <!-- Preload navbar HTML for faster loading -->
    <link rel="preload" href="navbar.html" as="document">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif !important;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
            overflow-x: hidden;
            scrollbar-gutter: stable;
            /* Navbar padding is handled by navbar.css */
        }
        
        /* Main Content */
        .main-content {
            padding: 2rem 0;
            padding-top: 1rem; /* Reduced since body already has padding-top */
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #0369a1;
            margin-bottom: 0.25rem;
        }
        
        .page-subtitle {
            color: #64748b;
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }
        
        /* Cart Container */
        .cart-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-top: 1rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
            margin-bottom: 1rem;
        }
        
        .cart-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #0369a1;
            margin: 0;
        }
        
        .item-count-badge {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
            white-space: nowrap;
        }
        
        /* Empty Cart */
        .empty-cart {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .empty-cart i {
            font-size: 5rem;
            color: #cbd5e1;
            margin-bottom: 1.5rem;
        }
        
        .empty-cart h3 {
            font-size: 1.5rem;
            color: #475569;
            margin-bottom: 0.5rem;
        }
        
        .empty-cart p {
            color: #94a3b8;
            margin-bottom: 2rem;
        }
        
        .btn-continue-shopping {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-continue-shopping::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-continue-shopping:hover::before {
            left: 100%;
        }
        
        .btn-continue-shopping i {
            display: inline-block;
            line-height: 1;
            font-size: 0.95rem;
            vertical-align: middle;
            margin: 0;
            padding: 0;
        }
        
        .btn-continue-shopping:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(14, 165, 233, 0.4);
            color: white;
        }
        
        .btn-continue-shopping:active {
            transform: translateY(-1px);
        }
        
        /* Cart Items */
        .cart-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid #f1f5f9;
            border-radius: 15px;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .cart-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: #e0f2fe;
        }
        
        .item-checkbox {
            margin-right: 1rem;
        }
        
        .item-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #0ea5e9;
        }
        
        .item-image {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .item-image i {
            font-size: 2rem;
            color: white;
        }
        
        .item-details {
            flex: 1;
            margin-right: 1rem;
        }
        
        .item-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.25rem;
        }
        
        .item-price {
            font-size: 0.95rem;
            color: #64748b;
        }
        
        .item-quantity {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-right: 1rem;
        }
        
        .quantity-controls {
            display: flex;
            align-items: stretch;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            width: 120px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            flex-wrap: nowrap;
        }
        
        .quantity-controls:hover {
            border-color: #0ea5e9;
            box-shadow: 0 4px 8px rgba(14, 165, 233, 0.15);
        }
        
        .quantity-controls:focus-within {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        .quantity-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            color: #475569;
            font-weight: 600;
            font-size: 1.2rem;
            position: relative;
            flex-shrink: 0;
            min-width: 40px;
            margin: 0;
            padding: 0;
        }
        
        .quantity-btn.decrease {
            border-right: 1px solid #e2e8f0;
        }
        
        .quantity-btn.increase {
            border-left: 1px solid #e2e8f0;
        }
        
        .quantity-controls:hover .quantity-btn.decrease {
            border-right-color: #0ea5e9;
        }
        
        .quantity-controls:hover .quantity-btn.increase {
            border-left-color: #0ea5e9;
        }
        
        .quantity-btn:hover {
            background: #e0f2fe;
            color: #0ea5e9;
        }
        
        .quantity-btn:active {
            background: #bae6fd;
            transform: scale(0.95);
        }
        
        .quantity-btn.decrease {
            border-radius: 8px 0 0 8px;
        }
        
        .quantity-btn.increase {
            border-radius: 0 8px 8px 0;
        }
        
        .quantity-input {
            flex: 1;
            height: 40px;
            border: none;
            border-left: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            text-align: center;
            font-weight: 700;
            font-size: 0.95rem;
            color: #0369a1;
            background: white;
            padding: 0 5px;
            min-width: 40px;
            display: block;
            -moz-appearance: textfield;
            margin: 0;
        }
        
        .quantity-controls:hover .quantity-input {
            border-left-color: #0ea5e9;
            border-right-color: #0ea5e9;
        }
        
        .quantity-input:focus {
            outline: none;
            background: #f0f9ff;
            border-bottom: 2px solid #0ea5e9;
        }
        
        .quantity-controls:focus-within .quantity-input {
            border-left-color: #0ea5e9;
            border-right-color: #0ea5e9;
        }
        
        .quantity-input::-webkit-inner-spin-button,
        .quantity-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .item-subtotal {
            font-size: 1.3rem;
            font-weight: 700;
            color: #0ea5e9;
            min-width: 100px;
            text-align: right;
            margin-right: 1rem;
        }
        
        .item-remove {
            background: #fee2e2;
            border: none;
            color: #ef4444;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .item-remove:hover {
            background: #ef4444;
            color: white;
            transform: scale(1.1);
        }
        
        /* Cart Summary */
        .cart-summary {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 1.25rem;
            width: 100%;
        }
        
        .cart-summary-wrapper {
            position: static;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            margin-top: 1rem; /* Extra spacing to avoid navbar overlap */
        }
        
        .cart-summary {
            width: 100%;
            max-width: 100%;
        }
        
        /* Ensure body and html don't interfere */
        html, body {
            overflow-x: hidden;
            position: relative;
        }
        
        /* Ensure no parent creates containing block */
        main,
        .main-content,
        .main-content .container,
        .main-content .row {
            transform: none !important;
            perspective: none !important;
            filter: none !important;
            will-change: auto !important;
        }
        
        @media (max-width: 991px) {
            .cart-summary-wrapper {
                width: 100%;
            }
        }
        
        .cart-summary::-webkit-scrollbar {
            width: 6px;
        }
        
        .cart-summary::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        .cart-summary::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        
        .cart-summary::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .summary-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0369a1;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            color: #475569;
        }
        
        .summary-row.total {
            border-top: 2px solid #f1f5f9;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            font-size: 1.15rem;
            font-weight: 700;
            color: #0369a1;
        }
        
        .summary-label {
            font-weight: 500;
        }
        
        .summary-value {
            font-weight: 600;
            color: #0f172a;
        }
        
        .summary-row.total .summary-value {
            font-size: 1.5rem;
            color: #0ea5e9;
        }
        
        .btn-checkout {
            width: 100%;
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            margin-top: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        
        .btn-checkout:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(14, 165, 233, 0.4);
            color: white;
        }
        
        .btn-checkout:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Select All */
        .select-all {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .select-all input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #0ea5e9;
        }
        
        .select-all label {
            font-weight: 600;
            color: #475569;
            cursor: pointer;
            margin: 0;
        }
        
        .btn-delete-all {
            margin-left: auto;
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #ef4444;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .btn-delete-all:hover {
            background: #ef4444;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }
        
        /* Delivery Address Section */
        .delivery-address-section {
            padding: 0;
        }
        
        .address-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
            margin-bottom: 1.5rem;
        }
        
        .cart-summary .delivery-address-section {
            margin-top: 0;
        }
        
        .address-header i {
            color: #ef4444;
            font-size: 1.3rem;
        }
        
        .address-header span {
            font-size: 1.3rem;
            font-weight: 700;
            color: #ef4444;
        }
        
        .address-content {
            min-height: 80px;
        }
        
        .empty-address {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
        }
        
        .empty-address p {
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }
        
        .btn-add-address {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-add-address:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
            color: white;
        }
        
        .address-display {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .address-display:hover {
            border-color: #0ea5e9;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.1);
        }
        
        .address-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            gap: 1rem;
        }
        
        .address-info {
            flex: 1;
        }
        
        .address-name-phone {
            font-size: 1.2rem;
            font-weight: 700;
            color: #0369a1;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .address-name-phone strong {
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .address-name-phone span {
            color: #64748b;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .address-text {
            color: #475569;
            line-height: 1.6;
            font-size: 0.9rem;
            background: white;
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 3px solid #0ea5e9;
            margin-top: 0;
        }
        
        .address-tabs {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .address-tab {
            background: transparent;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .address-tab:hover {
            color: #0ea5e9;
            background: rgba(14, 165, 233, 0.05);
        }
        
        .address-tab.active {
            color: #0ea5e9;
            border-bottom-color: #0ea5e9;
            background: rgba(14, 165, 233, 0.05);
        }
        
        .address-tab i {
            font-size: 0.75rem;
        }
        
        .address-tab-content-wrapper {
            min-height: 80px;
        }
        
        .address-tab-content {
            display: none;
        }
        
        .address-tab-content.active {
            display: block;
        }
        
        .address-location-section {
            padding: 0;
        }
        
        .address-coordinates {
            background: white;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border: 1px solid #e2e8f0;
        }
        
        .coordinates-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .coordinates-label i {
            color: #0ea5e9;
            font-size: 0.8rem;
        }
        
        .coordinates-display {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .coordinate-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .coordinate-label {
            font-weight: 600;
            color: #64748b;
            font-size: 0.85rem;
        }
        
        .coordinate-value {
            font-family: 'Courier New', monospace;
            color: #0369a1;
            font-weight: 600;
            font-size: 0.85rem;
            background: #f0f9ff;
            padding: 3px 6px;
            border-radius: 4px;
        }
        
        .address-map-container {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 0.5rem;
            position: relative;
        }
        
        .address-map-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10000;
            border-radius: 0;
            border: none;
            margin: 0;
        }
        
        .address-map-fullscreen-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: white;
            border: 2px solid #e2e8f0;
            color: #475569;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 1000;
        }
        
        .address-map-fullscreen-btn:hover {
            background: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        
        .address-map {
            width: 100%;
            height: 100%;
        }
        
        .address-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.75rem;
            flex-shrink: 0;
        }
        
        .badge-default {
            background: linear-gradient(135deg, #fff7ed, #ffedd5);
            color: #ea580c;
            border: 2px solid #ea580c;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(234, 88, 12, 0.2);
            white-space: nowrap;
        }
        
        .address-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-change-address {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(14, 165, 233, 0.2);
            white-space: nowrap;
        }
        
        .btn-change-address:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(14, 165, 233, 0.3);
            color: white;
        }
        
        .btn-delete-address {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #ef4444;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
            min-width: 40px;
        }
        
        .btn-delete-address:hover {
            background: #ef4444;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }
        
        /* Delete Confirmation Modal - Unique Design */
        .delete-confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeInModal 0.25s ease;
        }
        
        @keyframes fadeInModal {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(8px);
            }
        }
        
        .delete-confirm-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 24px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
            max-width: 420px;
            width: 90%;
            animation: modalScaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
            position: relative;
        }
        
        @keyframes modalScaleIn {
            from {
                transform: scale(0.85) translateY(20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        .delete-confirm-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #ef4444);
            background-size: 200% 100%;
            animation: gradientShift 2s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        
        .delete-confirm-icon-wrapper {
            display: flex;
            justify-content: center;
            padding: 2rem 2rem 1rem;
            position: relative;
        }
        
        .delete-confirm-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.25);
            position: relative;
            animation: iconPulse 2s ease-in-out infinite;
        }
        
        @keyframes iconPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 8px 24px rgba(239, 68, 68, 0.25);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 12px 32px rgba(239, 68, 68, 0.35);
            }
        }
        
        .delete-confirm-icon i {
            font-size: 2.5rem;
            color: #ef4444;
            animation: iconShake 0.5s ease;
        }
        
        @keyframes iconShake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        
        .delete-confirm-body {
            padding: 0 2rem 1.5rem;
            text-align: center;
        }
        
        .delete-confirm-body h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f172a;
            margin: 0 0 0.75rem 0;
        }
        
        .delete-confirm-body p {
            font-size: 1rem;
            color: #64748b;
            margin: 0;
            line-height: 1.6;
        }
        
        .delete-confirm-footer {
            padding: 1.25rem 2rem 2rem;
            display: flex;
            gap: 0.75rem;
            justify-content: center;
        }
        
        .btn-confirm-cancel,
        .btn-confirm-delete {
            padding: 12px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid;
            flex: 1;
            max-width: 140px;
        }
        
        .btn-confirm-cancel {
            background: white;
            border-color: #e2e8f0;
            color: #475569;
        }
        
        .btn-confirm-cancel:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn-confirm-delete {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #ef4444;
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .btn-confirm-delete:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-color: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }
        
        /* Logout Confirm Modal Styles - Blue Theme */
        .logout-confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }
        
        .logout-confirm-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 24px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
            max-width: 420px;
            width: 90%;
            position: relative;
            overflow: hidden;
            animation: modalScaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center;
        }
        
        .logout-confirm-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            animation: gradientShift 3s ease infinite;
        }
        
        .logout-confirm-icon-wrapper {
            display: flex;
            justify-content: center;
            padding: 2rem 2rem 1rem;
            position: relative;
        }
        
        .logout-confirm-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(14, 165, 233, 0.3);
            position: relative;
            animation: iconFloat 2s ease-in-out infinite;
        }
        
        .logout-confirm-icon::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            opacity: 0.2;
            animation: iconPulseBlue 2s ease-in-out infinite;
        }
        
        .logout-confirm-icon i {
            font-size: 2.5rem;
            color: #0ea5e9;
            position: relative;
            z-index: 1;
            animation: iconBounce 0.6s ease;
        }
        
        .logout-confirm-body {
            padding: 1rem 2rem 1.5rem;
            text-align: center;
        }
        
        .logout-confirm-body h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 0.75rem;
            letter-spacing: -0.02em;
        }
        
        .logout-confirm-body p {
            font-size: 1rem;
            color: #64748b;
            line-height: 1.6;
            margin: 0;
        }
        
        .logout-confirm-footer {
            display: flex;
            gap: 1rem;
            padding: 1.5rem 2rem 2rem;
            justify-content: center;
        }
        
        .btn-logout-cancel,
        .btn-logout-confirm {
            padding: 12px 32px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            outline: none;
            min-width: 120px;
        }
        
        .btn-logout-cancel {
            background: #f1f5f9;
            color: #475569;
            border: 2px solid #e2e8f0;
        }
        
        .btn-logout-cancel:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn-logout-confirm {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.4);
        }
        
        .btn-logout-confirm:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.5);
        }
        
        .btn-logout-confirm:active {
            transform: translateY(0);
        }
        
        @keyframes iconFloat {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-8px);
            }
        }
        
        @keyframes iconPulseBlue {
            0%, 100% {
                opacity: 0.2;
                transform: scale(1);
            }
            50% {
                opacity: 0.3;
                transform: scale(1.05);
            }
        }
        
        /* Checkout Loading Modal */
        .checkout-loading-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeInModal 0.3s ease;
        }
        
        .checkout-loading-content {
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
            border-radius: 24px;
            padding: 3rem 2.5rem;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            max-width: 400px;
            width: 90%;
            animation: modalScaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }
        
        .checkout-loading-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #0ea5e9, #0284c7, #06b6d4, #0ea5e9);
            background-size: 200% 100%;
            animation: gradientShift 2s ease infinite;
        }
        
        .checkout-loading-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 1.5rem;
            position: relative;
        }
        
        .checkout-loading-spinner {
            width: 100%;
            height: 100%;
            border: 4px solid #e0f2fe;
            border-top: 4px solid #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .checkout-loading-icon i {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            color: #0ea5e9;
            animation: iconBounce 1.5s ease-in-out infinite;
        }
        
        @keyframes iconBounce {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
        }
        
        .checkout-loading-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: #0f172a;
            margin: 0;
        }
        
        .checkout-loading-subtext {
            font-size: 0.95rem;
            color: #64748b;
            margin: 0.5rem 0 0 0;
        }
        
        /* Address Modal - Unique Design */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(12px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeInModal 0.3s ease;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .address-modal {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #f0f9ff 100%);
            border-radius: 28px;
            width: 100%;
            max-width: 720px;
            max-height: 92vh;
            overflow: hidden;
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
            animation: addressModalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        @keyframes addressModalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(30px) rotateX(10deg);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0) rotateX(0deg);
            }
        }
        
        .address-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #0ea5e9, #0284c7, #06b6d4, #0891b2, #0ea5e9);
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite;
            z-index: 1;
        }
        
        .address-modal::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.08) 0%, transparent 70%);
            animation: rotateGradient 20s linear infinite;
            pointer-events: none;
        }
        
        @keyframes rotateGradient {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #06b6d4 100%);
            padding: 2rem 2rem 1.5rem;
            border-bottom: none;
            border-radius: 28px 28px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .modal-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
            animation: rotateGradient 15s linear infinite;
        }
        
        .modal-header h2 {
            font-size: 1.75rem;
            font-weight: 800;
            color: white;
            margin: 0;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .modal-header h2::before {
            content: 'üìç';
            font-size: 1.5rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            animation: iconFloat 3s ease-in-out infinite;
        }
        
        @keyframes iconFloat {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        
        .modal-body {
            background: transparent;
            flex: 1;
            overflow-y: auto;
            padding: 2rem 2rem 1.5rem;
            max-height: calc(92vh - 250px);
            position: relative;
            z-index: 1;
        }
        
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-body::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        .modal-body::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            border-radius: 10px;
        }
        
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #0284c7, #0369a1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .form-group {
            margin-bottom: 0.75rem;
            position: relative;
        }
        
        .form-group.error input,
        .form-group.error select {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .form-group input.success,
        .form-group select.success {
            border-color: #0ea5e9;
            background: #f0f9ff;
            box-shadow: 0 0 0 0.2rem rgba(14, 165, 233, 0.25);
        }
        
        .form-group.error input:focus,
        .form-group.error select:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.12), 0 4px 12px rgba(239, 68, 68, 0.15);
        }
        
        .form-group input.success,
        .form-group select.success {
            border-color: #0ea5e9;
            background: #f0f9ff;
            box-shadow: 0 0 0 0.2rem rgba(14, 165, 233, 0.25);
        }
        
        .profile-section {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1.5rem;
        }
        
        .profile-section:last-of-type {
            border-bottom: none;
        }
        
        #updateProfileBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #94a3b8 !important;
        }
        
        #updateProfileBtn:disabled:hover {
            background: #94a3b8 !important;
            transform: none;
        }
        
        .form-group .error-message {
            display: none;
            margin-top: 0.4rem;
            padding: 0.5rem 0.75rem;
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border: 1px solid #fca5a5;
            border-radius: 8px;
            color: #991b1b;
            font-size: 0.85rem;
            font-weight: 500;
            position: relative;
            animation: errorSlideIn 0.3s ease;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.15);
        }
        
        .form-group.error .error-message {
            display: block;
        }
        
        .form-group .error-message::before {
            content: '‚ö†Ô∏è';
            margin-right: 0.5rem;
            font-size: 0.9rem;
        }
        
        @keyframes errorSlideIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #0f172a;
            font-size: 0.9rem;
            letter-spacing: 0.01em;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            autocomplete: off;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.12), 0 4px 12px rgba(14, 165, 233, 0.15);
            background: linear-gradient(to bottom, #ffffff, #f8faff);
            transform: translateY(-1px);
        }
        
        .form-group.error input:focus,
        .form-group.error select:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.12), 0 4px 12px rgba(239, 68, 68, 0.15);
        }
        
        .form-group input:hover,
        .form-group select:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .form-group.error input:hover,
        .form-group.error select:hover {
            border-color: #f87171;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }
        
        .map-placeholder {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px dashed #0ea5e9;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
            position: relative;
            overflow: hidden;
        }
        
        .map-placeholder::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(14, 165, 233, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(2, 132, 199, 0.1) 0%, transparent 50%);
            animation: mapPulse 4s ease-in-out infinite;
        }
        
        @keyframes mapPulse {
            0%, 100% {
                opacity: 0.5;
            }
            50% {
                opacity: 0.8;
            }
        }
        
        .map-placeholder::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(90deg, rgba(14, 165, 233, 0.1) 1px, transparent 1px),
                linear-gradient(rgba(14, 165, 233, 0.1) 1px, transparent 1px);
            background-size: 25px 25px;
            opacity: 0.4;
        }
        
        .btn-add-location {
            background: linear-gradient(135deg, #ffffff, #f8faff);
            border: 2px solid #0ea5e9;
            color: #0ea5e9;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
            position: relative;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
        }
        
        .btn-add-location:hover {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.35);
        }
        
        .btn-add-location:active {
            transform: translateY(0);
        }
        
        .map-container {
            width: 100%;
            height: 400px;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            margin-bottom: 0.75rem;
            border: 2px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .map-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10000;
            border-radius: 0;
            border: none;
        }
        
        .map-container.fullscreen .map-controls {
            top: 20px;
            right: 20px;
        }
        
        .map-container #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 8px;
        }
        
        .btn-map-control {
            background: white;
            border: 2px solid #e2e8f0;
            color: #475569;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-map-control:hover {
            background: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            font-weight: 600;
            color: #0ea5e9;
        }
        
        .map-loading i {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Leaflet custom styles */
        .leaflet-container {
            font-family: 'Poppins', sans-serif;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .leaflet-popup-content {
            margin: 12px 16px;
            font-weight: 600;
            color: #0369a1;
        }
        
        .label-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .label-section span {
            font-weight: 600;
            color: #475569;
            font-size: 0.85rem;
        }
        
        .label-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .label-btn {
            padding: 12px 28px;
            border: 2px solid #e2e8f0;
            background: white;
            color: #94a3b8;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.95rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }
        
        .label-btn:hover {
            border-color: #0ea5e9;
            color: #0ea5e9;
            background: #f0f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
        }
        
        .label-btn.active {
            border-color: #0ea5e9;
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.4);
            transform: translateY(-2px);
        }
        
        .modal-footer {
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            border-top: 2px solid #f1f5f9;
            background: linear-gradient(to bottom, #ffffff, #f8fafc);
            border-radius: 0 0 28px 28px;
            position: relative;
            z-index: 1;
        }
        
        .btn-cancel {
            padding: 12px 28px;
            border: 2px solid #e2e8f0;
            background: white;
            color: #64748b;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }
        
        .btn-cancel:hover {
            border-color: #cbd5e1;
            background: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn-submit {
            padding: 12px 28px;
            border: none;
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.35);
        }
        
        .btn-submit:hover {
            background: linear-gradient(135deg, #0284c7, #0369a1);
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(14, 165, 233, 0.45);
        }
        
        .btn-submit:active {
            transform: translateY(0);
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
        }
        
        /* Override Bootstrap success alert colors to blue */
        .alert-success {
            background-color: #dbeafe !important;
            border-color: #0ea5e9 !important;
            color: #0369a1 !important;
        }
        
        .alert-success i {
            color: #0ea5e9 !important;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .address-display {
                flex-direction: column;
            }
            
            .address-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        /* Pagination */
        .pagination-container {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid #f1f5f9;
        }
        
        .pagination {
            margin: 0;
        }
        
        .pagination .page-link {
            color: #0ea5e9;
            border: 2px solid #e2e8f0;
            padding: 10px 16px;
            margin: 0 4px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .pagination .page-link:hover {
            background: #e0f2fe;
            border-color: #0ea5e9;
            color: #0ea5e9;
        }
        
        .pagination .page-item.active .page-link {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            border-color: #0ea5e9;
            color: white;
        }
        
        .pagination .page-item.disabled .page-link {
            color: #cbd5e1;
            border-color: #e2e8f0;
            cursor: not-allowed;
        }
        
        /* Footer Styles */
        .footer {
            background: #0369a1;
            color: white;
            padding: 20px 0 15px;
            margin-top: 4rem;
        }
        
        .footer-title {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 0.7rem;
        }
        
        .footer-link {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            display: block;
            margin-bottom: 0.3rem;
        }
        
        .footer-link:hover {
            color: white;
            transform: translateX(5px);
        }
        
        .social-icons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .social-icons a {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.3s ease;
        }
        
        .social-icons a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        @media (max-width: 768px) {
            .cart-item {
                flex-wrap: wrap;
            }
            
            .item-details {
                flex-basis: 100%;
                margin-bottom: 1rem;
            }
            
            .item-quantity {
                margin-right: 0;
            }
            
            .item-subtotal {
                margin-right: 0;
                margin-left: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <!-- Navbar will be loaded here by navbar.js -->
    <div id="navbar-container">
        <!-- Navbar loads here immediately -->
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            
            <div class="row">
                <!-- Cart Items -->
                <div class="col-lg-8">
                    <div class="cart-container">
                        <div class="cart-header">
                            <div>
                                <h2>Shopping Cart</h2>
                                <p class="page-subtitle" style="margin: 0.5rem 0 0 0; font-size: 0.95rem;">Review your items before checkout</p>
                            </div>
                            <div class="item-count-badge" id="itemCount">0 items</div>
                        </div>
                        
                        <!-- Select All -->
                        <div class="select-all">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <label for="selectAll">Select All</label>
                            <button type="button" class="btn-delete-all" id="deleteAllBtn" onclick="deleteAllSelected()" style="display: none;">
                                <i class="fas fa-trash me-2"></i>Delete All
                            </button>
                        </div>
                        
                        <!-- Cart Items List -->
                        <div id="cartItemsList">
                            <!-- Items will be dynamically inserted here -->
                        </div>
                        
                        <!-- Pagination -->
                        <div id="paginationContainer" class="pagination-container" style="display: none;">
                            <nav aria-label="Cart pagination">
                                <ul class="pagination justify-content-center" id="pagination">
                                    <!-- Pagination buttons will be dynamically inserted here -->
                                </ul>
                            </nav>
                        </div>
                        
                        <!-- Empty Cart State -->
                        <div id="emptyCart" class="empty-cart" style="display: none;">
                            <i class="fas fa-shopping-cart"></i>
                            <h3>Your cart is empty</h3>
                            <p>Looks like you haven't added any items to your cart yet.</p>
                            <a href="dashboard.html" class="btn btn-continue-shopping">
                                <i class="fas fa-arrow-left"></i>
                                Continue Shopping
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Cart Summary -->
                <div class="col-lg-4">
                    <div class="cart-summary-wrapper">
                        <div class="cart-summary">
                            <h3 class="summary-title">Order Summary</h3>
                            
                            <div class="summary-row">
                                <span class="summary-label">Subtotal</span>
                                <span class="summary-value" id="subtotal">‚Ç±0.00</span>
                            </div>
                            
                            <div class="summary-row">
                                <span class="summary-label">Delivery Fee</span>
                                <span class="summary-value" id="deliveryFee">‚Ç±50.00</span>
                            </div>
                            
                            <div class="summary-row total">
                                <span class="summary-label">Total</span>
                                <span class="summary-value" id="total">‚Ç±0.00</span>
                            </div>
                            
                            <button class="btn-checkout" id="checkoutBtn" onclick="proceedToCheckout()" disabled>
                                <i class="fas fa-credit-card me-2"></i>
                                Proceed to Checkout
                            </button>
                            
                            <a href="dashboard.html" class="btn btn-continue-shopping w-100 mt-2" style="justify-content: center;">
                                <i class="fas fa-arrow-left"></i>
                                Continue Shopping
                            </a>
                        </div>
                        
                        <!-- Delivery Address Section -->
                        <div class="cart-summary">
                            <div class="delivery-address-section" id="deliveryAddressSection">
                            <div class="address-header">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>Delivery Address</span>
                            </div>
                            <div id="addressContent" class="address-content">
                                <div class="empty-address" id="emptyAddress">
                                    <p>No delivery address set</p>
                                    <button class="btn-add-address" onclick="openAddressModal()">
                                        <i class="fas fa-plus me-2"></i>
                                        Add Delivery Address
                                    </button>
                                </div>
                                <div class="address-display" id="addressDisplay" style="display: none;">
                                    <div class="address-header-row">
                                        <div class="address-info">
                                            <div class="address-name-phone">
                                                <strong id="addressName"></strong>
                                                <span id="addressPhone"></span>
                                            </div>
                                        </div>
                                        <div class="address-actions">
                                            <span class="badge-default" id="defaultBadge" style="display: none;">Default</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Tabs Navigation -->
                                    <div class="address-tabs" id="addressTabs" style="display: none;">
                                        <button class="address-tab active" onclick="switchAddressTab('details')" id="tabDetails">
                                            <i class="fas fa-info-circle"></i>
                                            Address Details
                                        </button>
                                        <button class="address-tab" onclick="switchAddressTab('location')" id="tabLocation">
                                            <i class="fas fa-map-marker-alt"></i>
                                            Location Map
                                        </button>
                                    </div>
                                    
                                    <!-- Tab Content -->
                                    <div class="address-tab-content-wrapper">
                                        <!-- Address Details Tab -->
                                        <div class="address-tab-content active" id="tabContentDetails">
                                            <div class="address-text" id="addressText"></div>
                                        </div>
                                        
                                        <!-- Location Map Tab -->
                                        <div class="address-tab-content" id="tabContentLocation" style="display: none;">
                                            <div class="address-location-section" id="addressLocationSection">
                                                <div class="address-coordinates">
                                                    <div class="coordinates-label">
                                                        <i class="fas fa-map-marker-alt"></i>
                                                        <span>Location Coordinates</span>
                                                    </div>
                                                    <div class="coordinates-display">
                                                        <div class="coordinate-item">
                                                            <span class="coordinate-label">Latitude:</span>
                                                            <span class="coordinate-value" id="displayLatitude"></span>
                                                        </div>
                                                        <div class="coordinate-item">
                                                            <span class="coordinate-label">Longitude:</span>
                                                            <span class="coordinate-value" id="displayLongitude"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="address-map-container" id="addressMapContainer">
                                                    <button class="address-map-fullscreen-btn" onclick="toggleAddressMapFullscreen()" title="Toggle fullscreen">
                                                        <i class="fas fa-expand" id="addressMapFullscreenIcon"></i>
                                                        Fullscreen
                                                    </button>
                                                    <div id="addressMap" class="address-map"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="address-buttons" style="margin-top: 0.75rem; display: flex; justify-content: flex-end; gap: 0.5rem;">
                                        <button class="btn-change-address" onclick="openAddressModal()">Change</button>
                                        <button class="btn-delete-address" onclick="deleteAddress()" title="Delete address">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Address Modal -->
    <div class="modal-overlay" id="addressModal" onclick="closeAddressModal(event)">
        <div class="address-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>New Address</h2>
            </div>
            <div class="modal-body">
                <form id="addressForm" onsubmit="saveAddress(event)" novalidate>
                    <div class="form-row">
                    <div class="form-group">
                        <label for="fullName">Full Name</label>
                        <input type="text" id="fullName" name="fullName" placeholder="Full Name" autocomplete="off" required>
                        <div class="error-message">Please fill out this field</div>
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Phone Number</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="Phone Number" autocomplete="off" pattern="[0-9]*" inputmode="numeric" required>
                        <div class="error-message">Please fill out this field</div>
                    </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Region</label>
                        <select id="region" name="region" autocomplete="off" required onchange="updateProvinces(); validateField(this);">
                            <option value="">Select Region</option>
                        </select>
                        <div class="error-message">Please select an item in the list</div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Province</label>
                        <select id="province" name="province" autocomplete="off" required onchange="updateCities(); validateField(this);" disabled>
                            <option value="">Select Province</option>
                        </select>
                        <div class="error-message">Please select an item in the list</div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>City/Municipality</label>
                        <select id="city" name="city" autocomplete="off" required onchange="updateBarangays(); validateField(this);" disabled>
                            <option value="">Select City/Municipality</option>
                        </select>
                        <div class="error-message">Please select an item in the list</div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Barangay</label>
                        <select id="barangay" name="barangay" autocomplete="off" required onchange="validateField(this);" disabled>
                            <option value="">Select Barangay</option>
                        </select>
                        <div class="error-message">Please select an item in the list</div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="postalCode">Postal Code</label>
                        <input type="text" id="postalCode" name="postalCode" placeholder="Postal Code" autocomplete="off" required>
                        <div class="error-message">Please fill out this field</div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="streetAddress">Street Name, Building, House No.</label>
                        <input type="text" id="streetAddress" name="streetAddress" placeholder="Street Name, Building, House No." autocomplete="off" required>
                        <div class="error-message">Please fill out this field</div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Location on Map</label>
                        <div id="mapPlaceholder" class="map-placeholder">
                            <button type="button" class="btn-add-location" onclick="initMap()">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                Add Location on Map
                            </button>
                        </div>
                        <div id="mapContainer" class="map-container" style="display: none;">
                            <div class="map-controls">
                                <button type="button" class="btn-map-control" onclick="getCurrentLocation()" title="Use my current location">
                                    <i class="fas fa-crosshairs"></i>
                                    My Location
                                </button>
                                <button type="button" class="btn-map-control" onclick="toggleMapFullscreen()" title="Toggle fullscreen">
                                    <i class="fas fa-expand" id="fullscreenIcon"></i>
                                    Fullscreen
                                </button>
                                <button type="button" class="btn-map-control" onclick="hideMap()" title="Hide map">
                                    <i class="fas fa-times"></i>
                                    Hide
                                </button>
                            </div>
                            <div id="map" style="height: 100%;"></div>
                            <div id="mapLoading" class="map-loading" style="display: none;">
                                <i class="fas fa-spinner"></i>
                                <span>Getting your location...</span>
                            </div>
                        </div>
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                        <div class="form-group full-width" id="locationDisplayGroup" style="display: none; margin-top: 1rem;">
                            <label>Location Coordinates</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="latitudeDisplay" class="form-control" placeholder="Latitude" readonly style="background: #f8f9fa; cursor: not-allowed;">
                                <input type="text" id="longitudeDisplay" class="form-control" placeholder="Longitude" readonly style="background: #f8f9fa; cursor: not-allowed;">
                                <button type="button" class="btn-map-control" onclick="clearLocation()" title="Clear location" style="white-space: nowrap; padding: 10px 16px;">
                                    <i class="fas fa-times"></i>
                                    Clear
                                </button>
                            </div>
                            <small style="color: #64748b; margin-top: 0.5rem; display: block;">
                                <i class="fas fa-info-circle"></i> Location has been set. You can click on the map or use "My Location" to change it.
                            </small>
                        </div>
                        <small id="locationHint" style="color: #64748b; margin-top: 0.5rem; display: block;">Click on the map to set your location, or use "My Location" to automatically detect it</small>
                    </div>
                    
                    <div class="label-section">
                        <span>Label As:</span>
                        <div class="label-buttons">
                            <button type="button" class="label-btn active" data-label="home" onclick="selectLabel(this, 'home')">Home</button>
                            <button type="button" class="label-btn" data-label="work" onclick="selectLabel(this, 'work')">Work</button>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn-cancel" onclick="closeAddressModal(event)">Cancel</button>
                        <button type="submit" class="btn-submit">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="delete-confirm-modal" style="display: none;">
        <div class="delete-confirm-content">
            <div class="delete-confirm-icon-wrapper">
                <div class="delete-confirm-icon">
                    <i class="fas fa-trash-alt"></i>
                </div>
            </div>
            <div class="delete-confirm-body">
                <h3>Confirm Deletion</h3>
                <p id="deleteConfirmMessage">Are you sure you want to delete this item?</p>
            </div>
            <div class="delete-confirm-footer">
                <button type="button" class="btn-confirm-cancel" id="deleteCancelBtn">Cancel</button>
                <button type="button" class="btn-confirm-delete" id="deleteConfirmBtn">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal" onclick="closeProfileModal(event)" style="display: none;">
        <div class="address-modal" onclick="event.stopPropagation()" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Profile</h2>
            </div>
            <div class="modal-body">
                <form id="profileForm" onsubmit="saveProfile(event)" novalidate>
                    <div class="profile-section" style="margin-bottom: 2rem;">
                        <h5 style="color: #0369a1; font-weight: 600; margin-bottom: 1rem; font-size: 1.1rem;">Account Information</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="profileUsername">Username</label>
                                <input type="text" id="profileUsername" name="username" placeholder="Choose a username" autocomplete="off" readonly style="background: #f8f9fa; cursor: not-allowed;">
                                <small style="color: #64748b; font-size: 0.85rem;">Username cannot be changed</small>
                            </div>
                            <div class="form-group">
                                <label for="profileEmail">Email</label>
                                <input type="email" id="profileEmail" name="email" placeholder="Enter your email" autocomplete="off" required>
                                <div class="error-message" id="profileEmail-error" style="display: none;">Email is required.</div>
                                <div class="error-message" id="profileEmail-format-error" style="display: none;">Please enter a valid email.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-section" style="margin-bottom: 2rem;">
                        <h5 style="color: #0369a1; font-weight: 600; margin-bottom: 1rem; font-size: 1.1rem;">Personal Information</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="profileFirstName">First Name</label>
                                <input type="text" id="profileFirstName" name="firstName" placeholder="Enter your first name" autocomplete="off" required>
                                <div class="error-message" id="profileFirstName-error" style="display: none;">First Name is required.</div>
                            </div>
                            <div class="form-group">
                                <label for="profileLastName">Last Name</label>
                                <input type="text" id="profileLastName" name="lastName" placeholder="Enter your last name" autocomplete="off" required>
                                <div class="error-message" id="profileLastName-error" style="display: none;">Last Name is required.</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="profileGender">Gender</label>
                                <select id="profileGender" name="gender" autocomplete="off" required>
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                                <div class="error-message" id="profileGender-error" style="display: none;">Please select an item in the list</div>
                            </div>
                            <div class="form-group">
                                <label for="profileBirthday">Birthday</label>
                                <input type="date" id="profileBirthday" name="birthday" autocomplete="off" required>
                                <div class="error-message" id="profileBirthday-error" style="display: none;">Date of birth is required.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-section" style="margin-bottom: 2rem;">
                        <h5 style="color: #0369a1; font-weight: 600; margin-bottom: 0.5rem; font-size: 1.1rem;">Change Password</h5>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem; font-style: italic;">
                            Leave these fields blank if you don't want to change your password.
                        </p>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="profilePassword">Current Password</label>
                                <div style="position: relative;">
                                    <input type="password" id="profilePassword" name="password" placeholder="Enter your current password" autocomplete="off" minlength="8">
                                    <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('profilePassword', this.querySelector('i'))" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); border: none; background: transparent; padding: 8px 12px;">
                                        <i class="fas fa-eye" id="iconProfilePassword"></i>
                                    </button>
                                </div>
                                <div class="error-message" id="profilePassword-required" style="display: none;">Password is required.</div>
                                <div class="error-message" id="profilePassword-min" style="display: none;">Password must be at least 8 characters.</div>
                                <div class="error-message" id="profilePassword-incorrect" style="display: none;">Current password is incorrect.</div>
                            </div>
                            <div class="form-group">
                                <label for="profileNewPassword">New Password</label>
                                <div style="position: relative;">
                                    <input type="password" id="profileNewPassword" name="newPassword" placeholder="Enter your new password" autocomplete="off" minlength="8">
                                    <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('profileNewPassword', this.querySelector('i'))" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); border: none; background: transparent; padding: 8px 12px;">
                                        <i class="fas fa-eye" id="iconProfileNewPassword"></i>
                                    </button>
                                </div>
                                <div class="error-message" id="profileNewPassword-required" style="display: none;">Password is required.</div>
                                <div class="error-message" id="profileNewPassword-min" style="display: none;">Password must be at least 8 characters.</div>
                                <div class="error-message" id="profileNewPassword-same" style="display: none;">You've already used this password before.</div>
                                
                                <label for="profileConfirmPassword" style="margin-top: 1rem;">Confirm New Password</label>
                                <div style="position: relative;">
                                    <input type="password" id="profileConfirmPassword" name="confirmPassword" placeholder="Confirm your new password" autocomplete="off" minlength="8">
                                    <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('profileConfirmPassword', this.querySelector('i'))" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); border: none; background: transparent; padding: 8px 12px;">
                                        <i class="fas fa-eye" id="iconProfileConfirmPassword"></i>
                                    </button>
                                </div>
                                <div class="error-message" id="profileConfirmPassword-required" style="display: none;">Password is required.</div>
                                <div class="error-message" id="profileConfirmPassword-min" style="display: none;">Password must be at least 8 characters.</div>
                                <div class="error-message" id="profileConfirmPassword-same" style="display: none;">You've already used this password before.</div>
                                <div class="error-message" id="profileConfirmPassword-mismatch" style="display: none;">Passwords do not match.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn-cancel" onclick="closeProfileModal(event)">Cancel</button>
                        <button type="submit" class="btn-submit" id="updateProfileBtn" disabled>Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal" onclick="closeSettingsModal(event)" style="display: none;">
        <div class="address-modal" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Settings</h2>
            </div>
            <div class="modal-body">
                <p style="color: #64748b; text-align: center; padding: 2rem 0;">Settings page coming soon...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeSettingsModal(event)">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Logout Confirmation Modal -->
    <div id="logoutConfirmModal" class="logout-confirm-modal" style="display: none;">
        <div class="logout-confirm-content">
            <div class="logout-confirm-icon-wrapper">
                <div class="logout-confirm-icon">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
            </div>
            <div class="logout-confirm-body">
                <h3>Confirm Logout</h3>
                <p id="logoutConfirmMessage">Are you sure you want to logout?</p>
            </div>
            <div class="logout-confirm-footer">
                <button type="button" class="btn-logout-cancel" id="logoutCancelBtn">Cancel</button>
                <button type="button" class="btn-logout-confirm" id="logoutConfirmBtn">Logout</button>
            </div>
        </div>
    </div>
    
    <!-- Checkout Loading Modal -->
    <div id="checkoutLoadingModal" class="checkout-loading-modal" style="display: none;">
        <div class="checkout-loading-content">
            <div class="checkout-loading-icon">
                <div class="checkout-loading-spinner"></div>
                <i class="fas fa-shopping-cart"></i>
            </div>
            <p class="checkout-loading-text">Redirecting to checkout...</p>
            <p class="checkout-loading-subtext">Please wait while we process your order</p>
        </div>
    </div>

    <!-- Shared Navbar JS - Load early to prevent lag -->
    <script src="navbar.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <script>
        // Check if Leaflet is ready
        function isMapReady() {
            return typeof L !== 'undefined';
        }
        // Preload cart data immediately to prevent layout shifts
        (function() {
            try {
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                const cartCount = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
                const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
                
                // Update cart count badge in navbar
                const cartCountElement = document.getElementById('cartCount');
                if (cartCountElement) {
                    cartCountElement.textContent = cartCount;
                    if (cartCount === 0) {
                        cartCountElement.style.display = 'none';
                    } else {
                        cartCountElement.style.display = 'flex';
                    }
                }
                
                // Update item count badge
                const itemCountElement = document.getElementById('itemCount');
                if (itemCountElement) {
                    itemCountElement.textContent = totalItems === 1 ? '1 item' : totalItems === 0 ? '0 items' : `${totalItems} items`;
                }
            } catch(e) {
                console.error('Error preloading cart:', e);
            }
        })();
        
        // Product icons mapping
        const productIcons = {
            1: 'fa-fill-drip',
            2: 'fa-tint',
            3: 'fa-wine-bottle',
            4: 'fa-wine-bottle',
            5: 'fa-hand-holding-water'
        };
        
        // Pagination variables
        let currentPage = 1;
        const itemsPerPage = 4;
        
        // Track selected items across all pages
        let selectedItems = new Set(JSON.parse(localStorage.getItem('selectedCartItems') || '[]'));
        
        // Load cart from localStorage
        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartItemsList = document.getElementById('cartItemsList');
            const emptyCart = document.getElementById('emptyCart');
            const itemCount = document.getElementById('itemCount');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            // Update cart count in navbar
            updateCartCount();
            
            if (cart.length === 0) {
                cartItemsList.innerHTML = '';
                emptyCart.style.display = 'block';
                document.getElementById('paginationContainer').style.display = 'none';
                const itemCountBadge = document.getElementById('itemCount');
                if (itemCountBadge) {
                    itemCountBadge.textContent = '0 items';
                }
                checkoutBtn.disabled = true;
                clearSelection();
                updateSummary();
                return;
            }
            
            emptyCart.style.display = 'none';
            const itemCountBadge = document.getElementById('itemCount');
            if (itemCountBadge) {
                itemCountBadge.textContent = `${cart.length} ${cart.length === 1 ? 'item' : 'items'}`;
            }
            updateCheckoutButton(); // Check both cart items and address
            
            // Render pagination
            renderPagination(cart.length);
            
            // Render current page items
            renderCartItems(cart);
            
            // Update select all state after rendering
            updateSelectAllState();
        }
        
        // Clear selection when cart is empty
        function clearSelection() {
            selectedItems.clear();
            localStorage.removeItem('selectedCartItems');
        }
        
        function renderCartItems(cart) {
            const cartItemsList = document.getElementById('cartItemsList');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentItems = cart.slice(startIndex, endIndex);
            
            // Get the actual index in the full cart array for data-item-id
            cartItemsList.innerHTML = currentItems.map((item, localIndex) => {
                const actualIndex = startIndex + localIndex;
                const subtotal = item.price * item.quantity;
                const icon = productIcons[item.id] || 'fa-tint';
                const isChecked = selectedItems.has(item.id);
                
                return `
                    <div class="cart-item" data-item-id="${item.id}" data-cart-index="${actualIndex}">
                        <div class="item-checkbox">
                            <input type="checkbox" class="item-checkbox-input" ${isChecked ? 'checked' : ''} onchange="toggleItemSelection(${item.id}, this.checked)">
                        </div>
                        <div class="item-image">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-price">‚Ç±${item.price.toFixed(2)} per unit</div>
                        </div>
                        <div class="item-quantity">
                            <div class="quantity-controls">
                                <button type="button" class="quantity-btn decrease" onclick="updateQuantity(${item.id}, -1)">‚àí</button>
                                <input type="number" class="quantity-input" id="qty-cart-${item.id}" value="${item.quantity}" min="1" onchange="updateQuantityInput(${item.id})">
                                <button type="button" class="quantity-btn increase" onclick="updateQuantity(${item.id}, 1)">+</button>
                            </div>
                        </div>
                        <div class="item-subtotal" id="subtotal-${item.id}">
                            ‚Ç±${subtotal.toFixed(2)}
                        </div>
                        <button class="item-remove" onclick="removeItem(${item.id})" title="Remove item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
            
            updateSummary();
        }
        
        function renderPagination(totalItems) {
            const paginationContainer = document.getElementById('paginationContainer');
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'block';
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    `;
                }
            }
            
            // Next button
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
            
            pagination.innerHTML = paginationHTML;
        }
        
        function changePage(page) {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const totalPages = Math.ceil(cart.length / itemsPerPage);
            
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderCartItems(cart);
            renderPagination(cart.length);
            
            // Scroll to top of cart items
            document.getElementById('cartItemsList').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Update quantity
        function updateQuantity(productId, change) {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const item = cart.find(i => i.id === productId);
            
            if (!item) return;
            
            item.quantity += change;
            
            if (item.quantity < 1) {
                item.quantity = 1;
            }
            
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount(); // Update navbar count immediately
            loadCart();
        }
        
        // Update quantity from input
        function updateQuantityInput(productId) {
            const input = document.getElementById(`qty-cart-${productId}`);
            const quantity = parseInt(input.value) || 1;
            
            if (quantity < 1) {
                input.value = 1;
                return;
            }
            
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const item = cart.find(i => i.id === productId);
            
            if (item) {
                item.quantity = quantity;
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartCount(); // Update navbar count immediately
                loadCart();
            }
        }
        
        // Remove item
        function removeItem(productId) {
            showDeleteConfirmModal(() => {
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                const filteredCart = cart.filter(item => item.id !== productId);
                
                localStorage.setItem('cart', JSON.stringify(filteredCart));
                updateCartCount(); // Update navbar count immediately
                loadCart();
                showNotification('Item removed from cart', 'success');
            }, 'Remove this item from cart?');
        }
        
        // Update summary (works across all pages)
        function updateSummary() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            
            // Calculate subtotal from all selected items (not just visible ones)
            let subtotal = 0;
            selectedItems.forEach(itemId => {
                const item = cart.find(i => i.id === itemId);
                if (item) {
                    subtotal += item.price * item.quantity;
                }
            });
            
            const deliveryFee = subtotal > 0 ? 50 : 0;
            const total = subtotal + deliveryFee;
            
            document.getElementById('subtotal').textContent = `‚Ç±${subtotal.toFixed(2)}`;
            document.getElementById('deliveryFee').textContent = `‚Ç±${deliveryFee.toFixed(2)}`;
            document.getElementById('total').textContent = `‚Ç±${total.toFixed(2)}`;
            
            // Update checkout button (check both items and address)
            updateCheckoutButton();
        }
        
        // Toggle individual item selection
        function toggleItemSelection(itemId, isChecked) {
            if (isChecked) {
                selectedItems.add(itemId);
            } else {
                selectedItems.delete(itemId);
            }
            
            // Save to localStorage
            localStorage.setItem('selectedCartItems', JSON.stringify(Array.from(selectedItems)));
            
            updateSummary();
            updateSelectAllState();
        }
        
        // Update select all checkbox state
        function updateSelectAllState() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const selectAll = document.getElementById('selectAll');
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            
            if (cart.length === 0) {
                selectAll.checked = false;
                deleteAllBtn.style.display = 'none';
                return;
            }
            
            // Check if all items are selected
            const allSelected = cart.every(item => selectedItems.has(item.id));
            selectAll.checked = allSelected;
            
            // Show/hide delete all button based on if any items are selected
            if (selectedItems.size > 0) {
                deleteAllBtn.style.display = 'flex';
            } else {
                deleteAllBtn.style.display = 'none';
            }
            
            // Update visible checkboxes to match selection state
            document.querySelectorAll('.item-checkbox-input').forEach(checkbox => {
                const cartItem = checkbox.closest('.cart-item');
                const itemId = parseInt(cartItem.getAttribute('data-item-id'));
                checkbox.checked = selectedItems.has(itemId);
            });
        }
        
        // Toggle select all (works across all pages)
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            
            if (selectAll.checked) {
                // Select all items across all pages
                cart.forEach(item => {
                    selectedItems.add(item.id);
                });
            } else {
                // Deselect all items
                selectedItems.clear();
            }
            
            // Save to localStorage
            localStorage.setItem('selectedCartItems', JSON.stringify(Array.from(selectedItems)));
            
            // Update visible checkboxes
            document.querySelectorAll('.item-checkbox-input').forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateSummary();
            updateSelectAllState();
        }
        
        // Delete all selected items (works across all pages)
        function deleteAllSelected() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const selectedCount = selectedItems.size;
            
            if (selectedCount === 0) {
                showNotification('No items selected', 'warning');
                return;
            }
            
            showDeleteConfirmModal(() => {
                // Remove all selected items from cart
                const updatedCart = cart.filter(item => !selectedItems.has(item.id));
                localStorage.setItem('cart', JSON.stringify(updatedCart));
                
                // Clear selection
                selectedItems.clear();
                localStorage.removeItem('selectedCartItems');
                
                // Uncheck select all
                document.getElementById('selectAll').checked = false;
                document.getElementById('deleteAllBtn').style.display = 'none';
                
                // Reset to page 1 if current page is empty
                const totalPages = Math.ceil(updatedCart.length / itemsPerPage);
                if (currentPage > totalPages && totalPages > 0) {
                    currentPage = totalPages;
                } else if (totalPages === 0) {
                    currentPage = 1;
                }
                
                loadCart();
                updateCartCount();
                showNotification(`${selectedCount} item${selectedCount !== 1 ? 's' : ''} deleted successfully!`, 'success');
            }, `Are you sure you want to delete ${selectedCount} selected item${selectedCount !== 1 ? 's' : ''}?`);
        }
        
        // Update cart count in navbar
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const cartCountElement = document.getElementById('cartCount');
            if (cartCountElement) {
                cartCountElement.textContent = cartCount;
                // Hide badge if count is 0
                if (cartCount === 0) {
                    cartCountElement.style.display = 'none';
                } else {
                    cartCountElement.style.display = 'flex';
                }
            }
        }
        
        // Proceed to checkout
        function proceedToCheckout() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const checkoutItems = [];
            
            // Get all selected items (across all pages)
            selectedItems.forEach(itemId => {
                const item = cart.find(i => i.id === itemId);
                if (item) {
                    checkoutItems.push(item);
                }
            });
            
            if (checkoutItems.length === 0) {
                showNotification('Please select at least one item', 'error');
                return;
            }
            
            // Store selected items for checkout
            localStorage.setItem('checkoutItems', JSON.stringify(checkoutItems));
            
            // Show checkout loading modal
            showCheckoutLoading();
            
            // Redirect to payment page
            setTimeout(() => {
                window.location.href = 'payment.html';
            }, 1500);
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            // Don't show notification if it's checkout redirect (we use modal instead)
            if (message === 'Redirecting to checkout...') {
                return;
            }
            
            let alertClass = 'alert-success';
            let iconClass = 'fa-check-circle';
            
            if (type === 'error' || type === 'danger') {
                alertClass = 'alert-danger';
                iconClass = 'fa-exclamation-circle';
            } else if (type === 'warning') {
                alertClass = 'alert-warning';
                iconClass = 'fa-exclamation-triangle';
            }
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass}`;
            notification.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);';
            notification.innerHTML = `
                <i class="fas ${iconClass} me-2"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Show checkout loading modal
        function showCheckoutLoading() {
            const modal = document.getElementById('checkoutLoadingModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        // Hide checkout loading modal
        function hideCheckoutLoading() {
            const modal = document.getElementById('checkoutLoadingModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Laguna Location Data Only (CALABARZON Region)
        const philippineLocations = {
            'CALABARZON': {
                name: 'IV-A ‚Äì CALABARZON',
                provinces: {
                    'Laguna': {
                        cities: {
                            'Alaminos': {
                                barangays: ['Barangay I (Pob.)', 'Barangay II (Pob.)', 'Barangay III (Pob.)', 'Barangay IV (Pob.)', 'Del Carmen', 'Gulod', 'Magsaysay', 'Poblacion', 'San Agustin', 'San Andres', 'San Benito', 'San Gregorio', 'San Isidro', 'San Jose', 'San Juan', 'San Miguel', 'San Pablo', 'San Roque', 'Santa Cruz', 'Santa Maria', 'Santo Ni√±o', 'Santo Tomas']
                            },
                            'Bay': {
                                barangays: ['Bitin', 'Calo', 'Dila', 'Maitim', 'Masaya', 'Paciano Rizal', 'Puypuy', 'San Agustin', 'San Antonio', 'San Isidro', 'Tagumpay', 'Tranca']
                            },
                            'Bi√±an': {
                                barangays: ['Bungahan', 'Canlalay', 'Casile', 'De La Paz', 'Ganado', 'Langkiwa', 'Loma', 'Malaban', 'Malamig', 'Mampalasan', 'Platero', 'Poblacion', 'San Antonio', 'San Francisco', 'San Jose', 'San Vicente', 'Santo Domingo', 'Santo Ni√±o', 'Santo Tomas', 'Soro-Soro', 'Timbao', 'Tubigan', 'Zapote']
                            },
                            'Calauan': {
                                barangays: ['San Isidro', 'Poblacion I', 'Poblacion II', 'Poblacion III', 'Poblacion IV', 'Bubukal', 'Masili', 'Dayap', 'Lamot I', 'Lamot II', 'Limao', 'Mabacan', 'Masiit', 'Paliparan', 'Pansol', 'San Antonio', 'San Cristobal', 'San Juan', 'San Pablo', 'San Salvador', 'Santo Tomas', 'Santo Toribio', 'Talangan', 'Tambo', 'Tiaong', 'Tulay', 'Ulat', 'Ulong Tubig', 'Villa Espina', 'Villa Mercedes']
                            },
                            'Calamba': {
                                barangays: ['Bagong Kalsada', 'Banadero', 'Banlic', 'Barandal', 'Bucal', 'Bunggo', 'Burol', 'Camaligan', 'Canlubang', 'Halang', 'Hornalan', 'Kay-Anlog', 'La Mesa', 'Laguerta', 'Lawa', 'Lecheria', 'Lingga', 'Looc', 'Mabato', 'Majada Labas', 'Makiling', 'Mapagong', 'Masili', 'Maunong', 'Mayapa', 'Paciano Rizal', 'Palingon', 'Palo-Alto', 'Pansol', 'Parian', 'Prinza', 'Pulo', 'Puting Lupa', 'Real', 'Saimsim', 'Sampiruhan', 'San Cristobal', 'San Jose', 'San Juan', 'San Nicolas', 'San Roque', 'Santo Tomas', 'Sucol', 'Turbina', 'Ulango', 'Uwisan']
                            },
                            'Los Ba√±os': {
                                barangays: ['Anos', 'Bagong Silang', 'Bambang', 'Batong Malake', 'Baybayin', 'Lalakay', 'Maahas', 'Malinta', 'Mayondon', 'Putho-Tuntungin', 'San Antonio', 'Tadlac', 'Timugan']
                            },
                            'San Pedro': {
                                barangays: ['Bagong Silang', 'Calendola', 'Cuyab', 'Estrella', 'Landayan', 'Langgam', 'Magsaysay', 'Narra', 'Nueva', 'Pacita Complex I', 'Pacita Complex II', 'Poblacion', 'Rosario', 'San Antonio', 'San Roque', 'San Vicente', 'Santo Ni√±o', 'United Bayanihan', 'United Better Living']
                            },
                            'Santa Rosa': {
                                barangays: ['Aplaya', 'Balibago', 'Caingin', 'Dila', 'Labas', 'Macabling', 'Malitlit', 'Malusak', 'Poblacion', 'Pulong Santa Cruz', 'Sinalhan', 'Tagapo']
                            },
                            'Sta. Cruz': {
                                barangays: ['Bagumbayan', 'Bubukal', 'Calios', 'Duhat', 'Gatid', 'Jasaan', 'Labuin', 'Malinao', 'Oogong', 'Pagsawitan', 'Paiisa', 'Palasan', 'Patimbao', 'San Jose', 'San Juan', 'San Pablo Norte', 'San Pablo Sur', 'Santo Angel Norte', 'Santo Angel Sur', 'Santo Domingo', 'Tagbakin', 'Tuburan']
                            }
                        }
                    }
                }
            }
        };
        
        // Initialize location dropdowns
        function initializeLocationDropdowns() {
            const regionSelect = document.getElementById('region');
            if (!regionSelect) return;
            
            // Clear existing options
            regionSelect.innerHTML = '<option value="">Select Region</option>';
            
            // Populate regions (only Laguna now)
            Object.keys(philippineLocations).forEach(regionCode => {
                const region = philippineLocations[regionCode];
                const option = document.createElement('option');
                option.value = regionCode;
                option.textContent = region.name;
                regionSelect.appendChild(option);
            });
            
            // Auto-select CALABARZON if it's the only region
            if (Object.keys(philippineLocations).length === 1) {
                regionSelect.value = Object.keys(philippineLocations)[0];
                updateProvinces();
            }
        }
        
        // Update provinces based on selected region
        function updateProvinces() {
            const regionSelect = document.getElementById('region');
            const provinceSelect = document.getElementById('province');
            const citySelect = document.getElementById('city');
            const barangaySelect = document.getElementById('barangay');
            
            const selectedRegion = regionSelect.value;
            
            // Reset dependent dropdowns
            provinceSelect.innerHTML = '<option value="">Select Province</option>';
            citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
            
            if (selectedRegion && philippineLocations[selectedRegion]) {
                provinceSelect.disabled = false;
                const provinces = philippineLocations[selectedRegion].provinces;
                
                Object.keys(provinces).forEach(provinceName => {
                    const option = document.createElement('option');
                    option.value = provinceName;
                    option.textContent = provinceName;
                    provinceSelect.appendChild(option);
                });
            } else {
                provinceSelect.disabled = true;
                citySelect.disabled = true;
                barangaySelect.disabled = true;
            }
        }
        
        // Update cities based on selected province
        function updateCities() {
            const regionSelect = document.getElementById('region');
            const provinceSelect = document.getElementById('province');
            const citySelect = document.getElementById('city');
            const barangaySelect = document.getElementById('barangay');
            
            const selectedRegion = regionSelect.value;
            const selectedProvince = provinceSelect.value;
            
            // Reset dependent dropdowns
            citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
            
            if (selectedRegion && selectedProvince && philippineLocations[selectedRegion]) {
                const province = philippineLocations[selectedRegion].provinces[selectedProvince];
                if (province) {
                    citySelect.disabled = false;
                    const cities = province.cities;
                    
                    Object.keys(cities).forEach(cityName => {
                        const option = document.createElement('option');
                        option.value = cityName;
                        option.textContent = cityName;
                        citySelect.appendChild(option);
                    });
                }
            } else {
                citySelect.disabled = true;
                barangaySelect.disabled = true;
            }
        }
        
        // Update barangays based on selected city
        function updateBarangays() {
            const regionSelect = document.getElementById('region');
            const provinceSelect = document.getElementById('province');
            const citySelect = document.getElementById('city');
            const barangaySelect = document.getElementById('barangay');
            
            const selectedRegion = regionSelect.value;
            const selectedProvince = provinceSelect.value;
            const selectedCity = citySelect.value;
            
            // Reset barangay dropdown
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
            
            if (selectedRegion && selectedProvince && selectedCity && philippineLocations[selectedRegion]) {
                const province = philippineLocations[selectedRegion].provinces[selectedProvince];
                if (province && province.cities[selectedCity]) {
                    barangaySelect.disabled = false;
                    const barangays = province.cities[selectedCity].barangays;
                    
                    barangays.forEach(barangayName => {
                        const option = document.createElement('option');
                        option.value = barangayName;
                        option.textContent = barangayName;
                        barangaySelect.appendChild(option);
                    });
                }
            } else {
                barangaySelect.disabled = true;
            }
        }
        
        // Address Management
        function loadAddress() {
            const address = JSON.parse(localStorage.getItem('deliveryAddress'));
            const emptyAddress = document.getElementById('emptyAddress');
            const addressDisplay = document.getElementById('addressDisplay');
            const addressTabs = document.getElementById('addressTabs');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (address) {
                emptyAddress.style.display = 'none';
                addressDisplay.style.display = 'block';
                document.getElementById('addressName').textContent = address.fullName;
                document.getElementById('addressPhone').textContent = `(${address.phoneNumber})`;
                
                // Display full address with location breakdown
                let locationText = '';
                if (address.barangay && address.city && address.province) {
                    locationText = `${address.streetAddress}, ${address.barangay}, ${address.city}, ${address.province} ${address.postalCode || ''}`;
                } else if (address.location) {
                    // Fallback for old format
                    locationText = `${address.streetAddress}, ${address.location}, ${address.postalCode || ''}`;
                } else {
                    locationText = `${address.streetAddress}, ${address.postalCode || ''}`;
                }
                document.getElementById('addressText').textContent = locationText.trim();
                
                // Display coordinates and map if available
                if (address.latitude && address.longitude) {
                    const lat = parseFloat(address.latitude);
                    const lng = parseFloat(address.longitude);
                    
                    // Show tabs
                    if (addressTabs) {
                        addressTabs.style.display = 'flex';
                    }
                    
                    // Display coordinates
                    document.getElementById('displayLatitude').textContent = lat.toFixed(6);
                    document.getElementById('displayLongitude').textContent = lng.toFixed(6);
                    
                    // Initialize map (wait a bit for DOM to be ready)
                    setTimeout(() => {
                        initAddressMap(lat, lng);
                    }, 300);
                    
                    // Reset to details tab by default
                    switchAddressTab('details');
                } else {
                    // Hide tabs if no coordinates
                    if (addressTabs) {
                        addressTabs.style.display = 'none';
                    }
                }
                
                if (address.isDefault) {
                    document.getElementById('defaultBadge').style.display = 'block';
                } else {
                    document.getElementById('defaultBadge').style.display = 'none';
                }
                
                // Enable checkout button if cart has items
                updateCheckoutButton();
            } else {
                emptyAddress.style.display = 'block';
                addressDisplay.style.display = 'none';
                if (addressTabs) {
                    addressTabs.style.display = 'none';
                }
                // Disable checkout button if no address
                if (checkoutBtn) {
                    checkoutBtn.disabled = true;
                }
            }
        }
        
        // Switch address tab
        function switchAddressTab(tabName) {
            const tabDetails = document.getElementById('tabDetails');
            const tabLocation = document.getElementById('tabLocation');
            const contentDetails = document.getElementById('tabContentDetails');
            const contentLocation = document.getElementById('tabContentLocation');
            
            if (tabName === 'details') {
                // Show details tab
                tabDetails.classList.add('active');
                tabLocation.classList.remove('active');
                contentDetails.style.display = 'block';
                contentDetails.classList.add('active');
                contentLocation.style.display = 'none';
                contentLocation.classList.remove('active');
            } else if (tabName === 'location') {
                // Show location tab
                tabLocation.classList.add('active');
                tabDetails.classList.remove('active');
                contentLocation.style.display = 'block';
                contentLocation.classList.add('active');
                contentDetails.style.display = 'none';
                contentDetails.classList.remove('active');
                
                // Resize map when switching to location tab
                setTimeout(() => {
                    if (addressMap) {
                        addressMap.invalidateSize();
                    }
                }, 200);
            }
        }
        
        // Toggle address map fullscreen
        function toggleAddressMapFullscreen() {
            const addressMapContainer = document.getElementById('addressMapContainer');
            const fullscreenIcon = document.getElementById('addressMapFullscreenIcon');
            
            if (!addressMapContainer) return;
            
            if (addressMapContainer.classList.contains('fullscreen')) {
                // Exit fullscreen
                addressMapContainer.classList.remove('fullscreen');
                if (fullscreenIcon) {
                    fullscreenIcon.classList.remove('fa-compress');
                    fullscreenIcon.classList.add('fa-expand');
                }
                // Trigger map resize
                if (addressMap) {
                    setTimeout(() => {
                        addressMap.invalidateSize();
                    }, 100);
                }
            } else {
                // Enter fullscreen
                addressMapContainer.classList.add('fullscreen');
                if (fullscreenIcon) {
                    fullscreenIcon.classList.remove('fa-expand');
                    fullscreenIcon.classList.add('fa-compress');
                }
                // Trigger map resize
                if (addressMap) {
                    setTimeout(() => {
                        addressMap.invalidateSize();
                    }, 100);
                }
            }
        }
        
        function updateCheckoutButton() {
            const checkoutBtn = document.getElementById('checkoutBtn');
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const address = JSON.parse(localStorage.getItem('deliveryAddress'));
            const selectedItems = document.querySelectorAll('.item-checkbox-input:checked');
            
            if (checkoutBtn) {
                // Disable if no address or no items selected
                if (!address || selectedItems.length === 0 || cart.length === 0) {
                    checkoutBtn.disabled = true;
                } else {
                    checkoutBtn.disabled = false;
                }
            }
        }
        
        function openAddressModal() {
            const modal = document.getElementById('addressModal');
            if (!modal) {
                console.error('Address modal not found');
                return;
            }
            
            const address = JSON.parse(localStorage.getItem('deliveryAddress'));
            
            // Initialize location dropdowns first
            initializeLocationDropdowns();
            
            // Re-initialize phone number restriction when modal opens
            restrictPhoneNumberInput();
            
            // Reset map state
            mapInitialized = false;
            const mapPlaceholder = document.getElementById('mapPlaceholder');
            const mapContainer = document.getElementById('mapContainer');
            if (mapPlaceholder) mapPlaceholder.style.display = 'flex';
            if (mapContainer) mapContainer.style.display = 'none';
            
            if (address) {
                // Populate form with existing address
                document.getElementById('fullName').value = address.fullName || '';
                // Clean phone number to remove any non-numeric characters
                const phoneNumber = (address.phoneNumber || '').replace(/[^0-9]/g, '');
                document.getElementById('phoneNumber').value = phoneNumber;
                document.getElementById('postalCode').value = address.postalCode || '';
                document.getElementById('streetAddress').value = address.streetAddress || '';
                
                // Restore map coordinates if saved
                if (address.latitude && address.longitude) {
                    document.getElementById('latitude').value = address.latitude;
                    document.getElementById('longitude').value = address.longitude;
                    // Update visible display
                    updateLocationDisplay(parseFloat(address.latitude), parseFloat(address.longitude));
                } else {
                    document.getElementById('latitude').value = '';
                    document.getElementById('longitude').value = '';
                    // Hide location display
                    const locationDisplayGroup = document.getElementById('locationDisplayGroup');
                    const locationHint = document.getElementById('locationHint');
                    if (locationDisplayGroup) locationDisplayGroup.style.display = 'none';
                    if (locationHint) locationHint.style.display = 'block';
                }
                
                // Restore location if saved
                if (address.region) {
                    document.getElementById('region').value = address.region;
                    updateProvinces();
                    setTimeout(() => {
                        if (address.province) {
                            document.getElementById('province').value = address.province;
                            updateCities();
                            setTimeout(() => {
                                if (address.city) {
                                    document.getElementById('city').value = address.city;
                                    updateBarangays();
                                    setTimeout(() => {
                                        if (address.barangay) {
                                            document.getElementById('barangay').value = address.barangay;
                                        }
                                    }, 100);
                                }
                            }, 100);
                        }
                    }, 100);
                }
                
                // Set label
                document.querySelectorAll('.label-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.label === address.label) {
                        btn.classList.add('active');
                    }
                });
            } else {
                // Reset form
                document.getElementById('addressForm').reset();
                document.getElementById('region').value = '';
                document.getElementById('province').innerHTML = '<option value="">Select Province</option>';
                document.getElementById('province').disabled = true;
                document.getElementById('city').innerHTML = '<option value="">Select City/Municipality</option>';
                document.getElementById('city').disabled = true;
                document.getElementById('barangay').innerHTML = '<option value="">Select Barangay</option>';
                document.getElementById('barangay').disabled = true;
                document.querySelectorAll('.label-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('.label-btn[data-label="home"]').classList.add('active');
                
                // Clear location display
                clearLocation();
            }
            
            // Add validation listeners using event delegation
            const form = document.getElementById('addressForm');
            if (form) {
                // Use event delegation to handle all input/change events
                form.addEventListener('input', function(e) {
                    if (e.target.matches('input, select')) {
                        if (e.target.checkValidity()) {
                            validateField(e.target);
                        }
                    }
                }, true);
                form.addEventListener('change', function(e) {
                    if (e.target.matches('input, select')) {
                        validateField(e.target);
                    }
                }, true);
            }
            
            // Show modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        // Map variables
        let map = null;
        let marker = null;
        let mapInitialized = false;
        let popup = null;
        let addressMap = null;
        let addressMarker = null;
        
        // Initialize map
        function initMap() {
            const mapPlaceholder = document.getElementById('mapPlaceholder');
            const mapContainer = document.getElementById('mapContainer');
            const mapDiv = document.getElementById('map');
            
            if (!mapDiv) {
                console.error('Map div not found');
                return;
            }
            
            // Check if Leaflet is loaded
            if (!isMapReady()) {
                alert('Map library is still loading. Please wait a moment and try again.');
                return;
            }
            
            // Hide placeholder, show map container
            if (mapPlaceholder) mapPlaceholder.style.display = 'none';
            if (mapContainer) mapContainer.style.display = 'block';
            
            // Show loading
            const mapLoading = document.getElementById('mapLoading');
            if (mapLoading) mapLoading.style.display = 'flex';
            
            // Initialize map after a short delay to ensure container is visible
            setTimeout(() => {
                try {
                    if (!mapInitialized) {
                        // Default center: Calauan, Laguna, Philippines
                        const defaultCenter = [14.1500, 121.3167];
                        
                        // Check if we have saved coordinates
                        const address = JSON.parse(localStorage.getItem('deliveryAddress'));
                        let center = defaultCenter;
                        let zoom = 13;
                        
                        if (address && address.latitude && address.longitude) {
                            center = [parseFloat(address.latitude), parseFloat(address.longitude)];
                            zoom = 16;
                        }
                        
                        // Initialize Leaflet Map
                        map = L.map(mapDiv, {
                            center: center,
                            zoom: zoom,
                            zoomControl: true
                        });
                        
                        // Add OpenStreetMap tile layer
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            maxZoom: 19
                        }).addTo(map);
                        
                        // Custom marker icon (blue to match theme)
                        const customIcon = L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        });
                        
                        // Add marker if we have saved coordinates
                        if (address && address.latitude && address.longitude) {
                            const savedLat = parseFloat(address.latitude);
                            const savedLng = parseFloat(address.longitude);
                            
                            marker = L.marker([savedLat, savedLng], {
                                icon: customIcon,
                                draggable: true
                            }).addTo(map);
                            
                            // Add popup
                            popup = L.popup().setContent('<div style="padding: 8px;"><strong>Your location</strong></div>');
                            marker.bindPopup(popup).openPopup();
                            
                            // Update hidden inputs
                            document.getElementById('latitude').value = savedLat;
                            document.getElementById('longitude').value = savedLng;
                            
                            // Update visible display
                            updateLocationDisplay(savedLat, savedLng);
                            
                            // Handle marker drag
                            marker.on('dragend', function(e) {
                                const position = marker.getLatLng();
                                const lat = position.lat;
                                const lng = position.lng;
                                document.getElementById('latitude').value = lat;
                                document.getElementById('longitude').value = lng;
                                updateLocationDisplay(lat, lng);
                            });
                        }
                        
                        // Add click handler to set marker
                        map.on('click', function(e) {
                            const lat = e.latlng.lat;
                            const lng = e.latlng.lng;
                            
                            // Remove existing marker
                            if (marker) {
                                map.removeLayer(marker);
                            }
                            
                            // Add new marker
                            marker = L.marker([lat, lng], {
                                icon: customIcon,
                                draggable: true
                            }).addTo(map);
                            
                            // Add popup
                            popup = L.popup().setContent('<div style="padding: 8px;"><strong>Your location</strong></div>');
                            marker.bindPopup(popup).openPopup();
                            
                            // Update hidden inputs
                            document.getElementById('latitude').value = lat;
                            document.getElementById('longitude').value = lng;
                            
                            // Update visible display
                            updateLocationDisplay(lat, lng);
                            
                            // Handle marker drag
                            marker.on('dragend', function(e) {
                                const position = marker.getLatLng();
                                const newLat = position.lat;
                                const newLng = position.lng;
                                document.getElementById('latitude').value = newLat;
                                document.getElementById('longitude').value = newLng;
                                updateLocationDisplay(newLat, newLng);
                            });
                        });
                        
                        mapInitialized = true;
                    }
                    
                    // Trigger resize to ensure map renders correctly
                    setTimeout(() => {
                        if (map) {
                            map.invalidateSize();
                        }
                        if (mapLoading) mapLoading.style.display = 'none';
                    }, 100);
                } catch(error) {
                    console.error('Error initializing map:', error);
                    if (mapLoading) mapLoading.style.display = 'none';
                    alert('Error loading map. Please try again.');
                }
            }, 50);
        }
        
        // Get current location using HTML5 Geolocation API
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }
            
            // Ensure map is initialized first
            const mapContainer = document.getElementById('mapContainer');
            const mapPlaceholder = document.getElementById('mapPlaceholder');
            
            // If map is not visible, initialize it first
            if (!mapInitialized || !mapContainer || mapContainer.style.display === 'none') {
                if (mapPlaceholder && mapPlaceholder.style.display !== 'none') {
                    // Map hasn't been opened yet, initialize it first
                    initMap();
                    // Wait for map to initialize before requesting location
                    setTimeout(() => {
                        requestLocation();
                    }, 500);
                    return;
                }
            }
            
            // Map is already initialized, request location immediately
            requestLocation();
        }
        
        // Request location (separate function for better control)
        function requestLocation() {
            const mapLoading = document.getElementById('mapLoading');
            if (mapLoading) {
                mapLoading.style.display = 'flex';
                mapLoading.querySelector('span').textContent = 'Getting your location...';
            }
            
            // Show visual feedback
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer) {
                mapContainer.style.display = 'block';
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy; // Accuracy in meters
                    
                    console.log('Location retrieved successfully!');
                    console.log('Latitude:', lat);
                    console.log('Longitude:', lng);
                    console.log('Location accuracy:', accuracy, 'meters');
                    
                    // Validate coordinates
                    if (isNaN(lat) || isNaN(lng)) {
                        console.error('Invalid coordinates received:', lat, lng);
                        showNotification('Invalid location data received. Please try again.', 'error');
                        if (mapLoading) mapLoading.style.display = 'none';
                        return;
                    }
                    
                    // Check if accuracy is reasonable (within 1000 meters / 1km)
                    if (accuracy > 1000) {
                        console.warn('Location accuracy is low:', accuracy, 'meters. This may not be your exact location.');
                        // Still use it, but warn the user
                        showNotification('Location accuracy is limited. The marker may not be exactly at your location. You can drag it to adjust.', 'warning');
                    }
                    
                    // Ensure map container is visible
                    const mapContainer = document.getElementById('mapContainer');
                    const mapPlaceholder = document.getElementById('mapPlaceholder');
                    if (mapPlaceholder) mapPlaceholder.style.display = 'none';
                    if (mapContainer) mapContainer.style.display = 'block';
                    
                    // Ensure map is initialized
                    if (!mapInitialized || !map) {
                        console.log('Initializing map before setting location...');
                        initMap();
                        // Wait longer for mobile devices to ensure map is ready
                        setTimeout(() => {
                            setMapLocation(lat, lng);
                        }, 1000);
                    } else {
                        setMapLocation(lat, lng);
                    }
                    
                    if (mapLoading) {
                        mapLoading.style.display = 'none';
                    }
                },
                function(error) {
                    console.error('Geolocation error:', error);
                    if (mapLoading) {
                        mapLoading.style.display = 'none';
                    }
                    
                    let errorMsg = 'Unable to retrieve your location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Please allow location access in your browser settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Location information is unavailable. Please check your GPS/Wi-Fi settings.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Location request timed out. Please try again or check your internet connection.';
                            break;
                        default:
                            errorMsg += 'An unknown error occurred. Error code: ' + error.code;
                            break;
                    }
                    
                    // Show notification instead of alert for better UX
                    showNotification(errorMsg, 'error');
                },
                {
                    enableHighAccuracy: true, // Request high accuracy GPS
                    timeout: 30000, // Increased to 30 seconds to allow GPS to get accurate fix
                    maximumAge: 0 // Force fresh location, don't use cached data
                }
            );
        }
        
        // Set map location
        function setMapLocation(lat, lng) {
            console.log('setMapLocation called with:', lat, lng);
            
            // Update coordinates FIRST, even if map isn't ready
            const latInput = document.getElementById('latitude');
            const lngInput = document.getElementById('longitude');
            if (latInput) {
                latInput.value = lat;
                console.log('Latitude input set to:', lat);
            }
            if (lngInput) {
                lngInput.value = lng;
                console.log('Longitude input set to:', lng);
            }
            
            // Update visible display inputs
            updateLocationDisplay(lat, lng);
            
            // Ensure map is initialized
            if (!map || !mapInitialized) {
                console.log('Map not ready, initializing...');
                // Make sure map container is visible
                const mapContainer = document.getElementById('mapContainer');
                const mapPlaceholder = document.getElementById('mapPlaceholder');
                if (mapPlaceholder) mapPlaceholder.style.display = 'none';
                if (mapContainer) mapContainer.style.display = 'block';
                
                initMap();
                // Wait longer for mobile devices
                setTimeout(() => {
                    setMapLocation(lat, lng);
                }, 1000);
                return;
            }
            
            try {
                // Custom marker icon (blue to match theme)
                const customIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });
                
                // Remove existing marker
                if (marker) {
                    map.removeLayer(marker);
                }
                
                // Set map center and zoom
                map.setView([lat, lng], 16);
                console.log('Map view set to:', lat, lng);
                
                // Add new marker
                marker = L.marker([lat, lng], {
                    icon: customIcon,
                    draggable: true
                }).addTo(map);
                console.log('Marker added to map');
                
                // Add popup
                popup = L.popup().setContent('<div style="padding: 8px;"><strong>Your location</strong></div>');
                marker.bindPopup(popup).openPopup();
                
                // Allow dragging marker
                marker.on('dragend', function(e) {
                    const position = marker.getLatLng();
                    const newLat = position.lat;
                    const newLng = position.lng;
                    const latInput = document.getElementById('latitude');
                    const lngInput = document.getElementById('longitude');
                    if (latInput) latInput.value = newLat;
                    if (lngInput) lngInput.value = newLng;
                    updateLocationDisplay(newLat, newLng);
                });
                
                // Trigger resize to ensure map renders correctly (important for mobile)
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                        console.log('Map size invalidated');
                    }
                }, 200);
                
                // Show success notification
                showNotification('Location set successfully!', 'success');
            } catch(error) {
                console.error('Error setting map location:', error);
                // Even if marker fails, coordinates are already set
                showNotification('Location coordinates saved. You can manually adjust the marker on the map.', 'warning');
            }
        }
        
        // Update location display inputs
        function updateLocationDisplay(lat, lng) {
            console.log('updateLocationDisplay called with:', lat, lng);
            const latDisplay = document.getElementById('latitudeDisplay');
            const lngDisplay = document.getElementById('longitudeDisplay');
            const locationDisplayGroup = document.getElementById('locationDisplayGroup');
            const locationHint = document.getElementById('locationHint');
            
            if (latDisplay && lngDisplay && locationDisplayGroup) {
                latDisplay.value = lat.toFixed(6);
                lngDisplay.value = lng.toFixed(6);
                locationDisplayGroup.style.display = 'block';
                if (locationHint) locationHint.style.display = 'none';
                console.log('Location display updated:', latDisplay.value, lngDisplay.value);
            } else {
                console.error('Location display elements not found:', {
                    latDisplay: !!latDisplay,
                    lngDisplay: !!lngDisplay,
                    locationDisplayGroup: !!locationDisplayGroup
                });
            }
        }
        
        // Clear location
        function clearLocation() {
            // Remove marker
            if (marker && map) {
                map.removeLayer(marker);
                marker = null;
            }
            
            // Clear hidden inputs
            const latInput = document.getElementById('latitude');
            const lngInput = document.getElementById('longitude');
            if (latInput) latInput.value = '';
            if (lngInput) lngInput.value = '';
            
            // Clear display inputs
            const latDisplay = document.getElementById('latitudeDisplay');
            const lngDisplay = document.getElementById('longitudeDisplay');
            const locationDisplayGroup = document.getElementById('locationDisplayGroup');
            const locationHint = document.getElementById('locationHint');
            
            if (latDisplay) latDisplay.value = '';
            if (lngDisplay) lngDisplay.value = '';
            if (locationDisplayGroup) locationDisplayGroup.style.display = 'none';
            if (locationHint) locationHint.style.display = 'block';
        }
        
        // Hide map
        function hideMap() {
            const mapPlaceholder = document.getElementById('mapPlaceholder');
            const mapContainer = document.getElementById('mapContainer');
            
            if (mapPlaceholder) mapPlaceholder.style.display = 'flex';
            if (mapContainer) {
                mapContainer.style.display = 'none';
                mapContainer.classList.remove('fullscreen');
            }
        }
        
        // Toggle map fullscreen
        function toggleMapFullscreen() {
            const mapContainer = document.getElementById('mapContainer');
            const fullscreenIcon = document.getElementById('fullscreenIcon');
            
            if (!mapContainer) return;
            
            if (mapContainer.classList.contains('fullscreen')) {
                // Exit fullscreen
                mapContainer.classList.remove('fullscreen');
                if (fullscreenIcon) {
                    fullscreenIcon.classList.remove('fa-compress');
                    fullscreenIcon.classList.add('fa-expand');
                }
                // Trigger map resize
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                }
            } else {
                // Enter fullscreen
                mapContainer.classList.add('fullscreen');
                if (fullscreenIcon) {
                    fullscreenIcon.classList.remove('fa-expand');
                    fullscreenIcon.classList.add('fa-compress');
                }
                // Trigger map resize
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                }
            }
        }
        
        // Initialize address map (for display in delivery address section)
        function initAddressMap(lat, lng) {
            const addressMapDiv = document.getElementById('addressMap');
            if (!addressMapDiv || !isMapReady()) return;
            
            // Remove existing map if any
            if (addressMap) {
                addressMap.remove();
                addressMap = null;
                addressMarker = null;
            }
            
            try {
                // Initialize Leaflet Map
                addressMap = L.map(addressMapDiv, {
                    center: [lat, lng],
                    zoom: 16,
                    zoomControl: true
                });
                
                // Add OpenStreetMap tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(addressMap);
                
                // Custom marker icon (blue to match theme)
                const customIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });
                
                // Add marker
                addressMarker = L.marker([lat, lng], {
                    icon: customIcon,
                    draggable: false
                }).addTo(addressMap);
                
                // Add popup
                const addressPopup = L.popup().setContent('<div style="padding: 8px;"><strong>Your delivery location</strong></div>');
                addressMarker.bindPopup(addressPopup).openPopup();
                
                // Trigger resize to ensure map renders correctly
                setTimeout(() => {
                    if (addressMap) {
                        addressMap.invalidateSize();
                    }
                }, 200);
            } catch(error) {
                console.error('Error initializing address map:', error);
            }
        }
        
        function closeAddressModal(event) {
            if (event && event.target.id !== 'addressModal' && !event.target.closest('.address-modal')) return;
            const modal = document.getElementById('addressModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = ''; // Restore scrolling
                
                // Reset map state when closing
                const mapPlaceholder = document.getElementById('mapPlaceholder');
                const mapContainer = document.getElementById('mapContainer');
                if (mapPlaceholder) mapPlaceholder.style.display = 'flex';
                if (mapContainer) mapContainer.style.display = 'none';
            }
        }
        
        function selectLabel(button, label) {
            document.querySelectorAll('.label-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
        }
        
        // Custom validation function
        function validateField(field) {
            const formGroup = field.closest('.form-group');
            if (field.checkValidity()) {
                formGroup.classList.remove('error');
            } else {
                formGroup.classList.add('error');
            }
        }
        
        // Validate form (generic function for both address and profile forms)
        function validateForm() {
            const form = event.target.closest('form');
            if (!form) return false;
            
            const fields = form.querySelectorAll('input[required], select[required]');
            let isValid = true;
            
            fields.forEach(field => {
                validateField(field);
                if (!field.checkValidity()) {
                    isValid = false;
                }
            });
            
            // Special validation for profile form passwords
            if (form.id === 'profileForm') {
                const password = document.getElementById('profilePassword').value;
                const confirmPassword = document.getElementById('profileConfirmPassword').value;
                
                if (password && password.length < 8) {
                    isValid = false;
                    const passwordGroup = document.getElementById('profilePassword').closest('.form-group');
                    passwordGroup.classList.add('error');
                }
                
                if (password && password !== confirmPassword) {
                    isValid = false;
                    const confirmPasswordGroup = document.getElementById('profileConfirmPassword').closest('.form-group');
                    confirmPasswordGroup.classList.add('error');
                }
            }
            
            return isValid;
        }
        
        // Add event listeners to clear errors on input
        // Restrict phone number input to numbers only
        function restrictPhoneNumberInput() {
            const phoneInput = document.getElementById('phoneNumber');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    // Remove any non-numeric characters
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
                
                phoneInput.addEventListener('keypress', function(e) {
                    // Prevent non-numeric key presses (allow backspace, delete, tab, enter, arrows)
                    if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize phone number restriction
            restrictPhoneNumberInput();
            
            const form = document.getElementById('addressForm');
            if (form) {
                const fields = form.querySelectorAll('input, select');
                fields.forEach(field => {
                    field.addEventListener('input', function() {
                        if (this.checkValidity()) {
                            validateField(this);
                        }
                    });
                    field.addEventListener('change', function() {
                        validateField(this);
                    });
                });
            }
        });
        
        // Validate all fields on form submit
        function validateForm() {
            const form = document.getElementById('addressForm');
            const fields = form.querySelectorAll('input[required], select[required]');
            let isValid = true;
            
            fields.forEach(field => {
                validateField(field);
                if (!field.checkValidity()) {
                    isValid = false;
                }
            });
            
            return isValid;
        }
        
        function saveAddress(event) {
            event.preventDefault();
            
            // Validate all fields
            if (!validateForm()) {
                // Scroll to first error
                const firstError = document.querySelector('.form-group.error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            
            const region = document.getElementById('region').value;
            const province = document.getElementById('province').value;
            const city = document.getElementById('city').value;
            const barangay = document.getElementById('barangay').value;
            
            if (!region || !province || !city || !barangay) {
                showNotification('Please complete all location fields', 'error');
                return;
            }
            
            // Get map coordinates if available
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            
            const address = {
                fullName: document.getElementById('fullName').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                region: region,
                province: province,
                city: city,
                barangay: barangay,
                location: `${barangay}, ${city}, ${province}`, // For backward compatibility
                postalCode: document.getElementById('postalCode').value,
                streetAddress: document.getElementById('streetAddress').value,
                label: document.querySelector('.label-btn.active').dataset.label,
                isDefault: true, // First address is always default
                latitude: latitude || null,
                longitude: longitude || null
            };
            
            localStorage.setItem('deliveryAddress', JSON.stringify(address));
            loadAddress();
            updateCheckoutButton(); // Enable checkout when address is saved
            closeAddressModal();
            showNotification('Delivery address saved successfully!', 'success');
        }
        
        function deleteAddress() {
            showDeleteConfirmModal(() => {
                localStorage.removeItem('deliveryAddress');
                loadAddress();
                updateCheckoutButton(); // Disable checkout when address is deleted
                showNotification('Delivery address deleted successfully!', 'success');
            }, 'Are you sure you want to delete this delivery address?');
        }
        
        // Show delete confirmation modal
        function showDeleteConfirmModal(onConfirm, message) {
            const modal = document.getElementById('deleteConfirmModal');
            const messageEl = document.getElementById('deleteConfirmMessage');
            const confirmBtn = document.getElementById('deleteConfirmBtn');
            const cancelBtn = document.getElementById('deleteCancelBtn');
            
            messageEl.textContent = message;
            modal.style.display = 'flex';
            
            // Remove existing event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            const newCancelBtn = cancelBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            
            // Add new event listeners
            newConfirmBtn.addEventListener('click', function confirmHandler() {
                modal.style.display = 'none';
                onConfirm();
                newConfirmBtn.removeEventListener('click', confirmHandler);
            });
            
            newCancelBtn.addEventListener('click', function cancelHandler() {
                modal.style.display = 'none';
                newCancelBtn.removeEventListener('click', cancelHandler);
            });
        }
        
        // Load user data
        function loadUserData() {
            // Try to fetch from server first, then fallback to localStorage
            fetch('api/get_current_user.php')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch user data');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.user) {
                        const userData = data.user;
                        // Save to localStorage
                        localStorage.setItem('loggedInUser', JSON.stringify(userData));
                        localStorage.setItem('userData', JSON.stringify(userData));
                        
                        const usernameDisplay = document.getElementById('usernameDisplay');
                        if (usernameDisplay) {
                            usernameDisplay.textContent = userData.username || 'User';
                        }
                    } else {
                        // Fallback to localStorage
                        const userData = JSON.parse(localStorage.getItem('loggedInUser')) || 
                                       JSON.parse(localStorage.getItem('userData')) || 
                                       JSON.parse(sessionStorage.getItem('userData')) || {};
                        const usernameDisplay = document.getElementById('usernameDisplay');
                        if (usernameDisplay) {
                            usernameDisplay.textContent = userData.username || 'User';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                    // Fallback to localStorage
                    const userData = JSON.parse(localStorage.getItem('loggedInUser')) || 
                                   JSON.parse(localStorage.getItem('userData')) || 
                                   JSON.parse(sessionStorage.getItem('userData')) || {};
                    const usernameDisplay = document.getElementById('usernameDisplay');
                    if (usernameDisplay) {
                        usernameDisplay.textContent = userData.username || 'User';
                    }
                });
        }
        
        // Open Profile Page
        function openProfileModal() {
            window.location.href = 'profile.html';
            return;
            
            // Set flag to prevent success states on initial load
            isInitialProfileLoad = true;
            
            // Reset button state
            const updateBtn = document.getElementById('updateProfileBtn');
            if (updateBtn) {
                updateBtn.disabled = false;
                updateBtn.textContent = 'Save Changes';
            }
            
            // Clear all success and error states from form fields immediately
            const allFields = modal.querySelectorAll('input, select');
            allFields.forEach(field => {
                field.classList.remove('success', 'error');
                const formGroup = field.closest('.form-group');
                if (formGroup) {
                    formGroup.classList.remove('error');
                }
            });
            
            // Clear any pending success timers
            Object.keys(profileSuccessTimers).forEach(key => {
                if (profileSuccessTimers[key]) {
                    clearTimeout(profileSuccessTimers[key]);
                    delete profileSuccessTimers[key];
                }
            });
            
            // Show loading state
            const form = document.getElementById('profileForm');
            if (form) {
                form.style.opacity = '0.5';
                form.style.pointerEvents = 'none';
            }
            
            // Fetch user data from server
            fetch('api/get_current_user.php')
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        return response.json().then(err => {
                            console.error('API Error:', err);
                            throw new Error(err.message || 'Failed to fetch user data');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('User data received:', data);
                    if (data.success && data.user) {
                        const userData = data.user;
                        console.log('User data to populate:', userData);
                        
                        // Save to localStorage for future use
                        localStorage.setItem('loggedInUser', JSON.stringify(userData));
                        localStorage.setItem('userData', JSON.stringify(userData));
                        
                        // Populate form with user data
                        document.getElementById('profileUsername').value = userData.username || '';
                        document.getElementById('profileEmail').value = userData.email || '';
                        document.getElementById('profileFirstName').value = userData.firstName || userData.first_name || '';
                        document.getElementById('profileLastName').value = userData.lastName || userData.last_name || '';
                        document.getElementById('profileGender').value = userData.gender || '';
                        
                        // Handle date format conversion if needed
                        let birthday = userData.birthday || userData.date_of_birth || '';
                        if (birthday && birthday.includes('/')) {
                            // Convert dd/mm/yyyy to yyyy-mm-dd for date input
                            const parts = birthday.split('/');
                            if (parts.length === 3) {
                                birthday = `${parts[2]}-${parts[1]}-${parts[0]}`;
                            }
                        }
                        document.getElementById('profileBirthday').value = birthday;
                        document.getElementById('profilePassword').value = '';
                        document.getElementById('profileNewPassword').value = '';
                        document.getElementById('profileConfirmPassword').value = '';
                        
                        console.log('Form populated with:', {
                            username: document.getElementById('profileUsername').value,
                            email: document.getElementById('profileEmail').value,
                            firstName: document.getElementById('profileFirstName').value,
                            lastName: document.getElementById('profileLastName').value,
                            gender: document.getElementById('profileGender').value,
                            birthday: document.getElementById('profileBirthday').value
                        });
                        
                        // Set max date to today
                        const today = new Date();
                        const yyyy = today.getFullYear();
                        const mm = String(today.getMonth() + 1).padStart(2, '0');
                        const dd = String(today.getDate()).padStart(2, '0');
                        document.getElementById('profileBirthday').max = `${yyyy}-${mm}-${dd}`;
                        
                        // Add event listeners for real-time validation
                        setupProfileValidation();
                        
                        // Initial validation check (success states are prevented by isInitialProfileLoad flag)
                        checkProfileRequiredFields();
                        
                        // Reset flag after a short delay to allow user interactions to show success states
                        setTimeout(() => {
                            isInitialProfileLoad = false;
                        }, 500);
                        
                        // Hide loading state
                        if (form) {
                            form.style.opacity = '1';
                            form.style.pointerEvents = 'auto';
                        }
                        
                        modal.style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                    } else {
                        console.warn('No user data in response:', data);
                        // Fallback to localStorage if server fetch fails
                        let userData = JSON.parse(localStorage.getItem('loggedInUser')) || 
                                      JSON.parse(localStorage.getItem('userData')) || 
                                      JSON.parse(sessionStorage.getItem('userData')) || {};
                        
                        // Populate form with existing user data
                        document.getElementById('profileUsername').value = userData.username || '';
                        document.getElementById('profileEmail').value = userData.email || '';
                        document.getElementById('profileFirstName').value = userData.firstName || userData.first_name || '';
                        document.getElementById('profileLastName').value = userData.lastName || userData.last_name || '';
                        document.getElementById('profileGender').value = userData.gender || '';
                        
                        let birthday = userData.birthday || userData.date_of_birth || '';
                        if (birthday && birthday.includes('/')) {
                            const parts = birthday.split('/');
                            if (parts.length === 3) {
                                birthday = `${parts[2]}-${parts[1]}-${parts[0]}`;
                            }
                        }
                        document.getElementById('profileBirthday').value = birthday;
                        document.getElementById('profilePassword').value = '';
                        document.getElementById('profileNewPassword').value = '';
                        document.getElementById('profileConfirmPassword').value = '';
                        
                        const today = new Date();
                        const yyyy = today.getFullYear();
                        const mm = String(today.getMonth() + 1).padStart(2, '0');
                        const dd = String(today.getDate()).padStart(2, '0');
                        document.getElementById('profileBirthday').max = `${yyyy}-${mm}-${dd}`;
                        
                        setupProfileValidation();
                        checkProfileRequiredFields();
                        
                        // Reset flag after a short delay to allow user interactions to show success states
                        setTimeout(() => {
                            isInitialProfileLoad = false;
                        }, 500);
                        
                        if (form) {
                            form.style.opacity = '1';
                            form.style.pointerEvents = 'auto';
                        }
                        
                        modal.style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                    }
                })
                .catch(error => {
                    console.error('Error fetching user data:', error);
                    
                    // Fallback to localStorage
                    let userData = JSON.parse(localStorage.getItem('loggedInUser')) || 
                                  JSON.parse(localStorage.getItem('userData')) || 
                                  JSON.parse(sessionStorage.getItem('userData')) || {};
                    
                    document.getElementById('profileUsername').value = userData.username || '';
                    document.getElementById('profileEmail').value = userData.email || '';
                    document.getElementById('profileFirstName').value = userData.firstName || userData.first_name || '';
                    document.getElementById('profileLastName').value = userData.lastName || userData.last_name || '';
                    document.getElementById('profileGender').value = userData.gender || '';
                    
                    let birthday = userData.birthday || userData.date_of_birth || '';
                    if (birthday && birthday.includes('/')) {
                        const parts = birthday.split('/');
                        if (parts.length === 3) {
                            birthday = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                    }
                    document.getElementById('profileBirthday').value = birthday;
                        document.getElementById('profilePassword').value = '';
                        document.getElementById('profileNewPassword').value = '';
                        document.getElementById('profileConfirmPassword').value = '';
                        
                        const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    document.getElementById('profileBirthday').max = `${yyyy}-${mm}-${dd}`;
                    
                    setupProfileValidation();
                    checkProfileRequiredFields();
                    
                    // Reset flag after a short delay to allow user interactions to show success states
                    setTimeout(() => {
                        isInitialProfileLoad = false;
                    }, 500);
                    
                    if (form) {
                        form.style.opacity = '1';
                        form.style.pointerEvents = 'auto';
                    }
                    
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                });
        }
        
        // Setup Profile Validation Event Listeners
        function setupProfileValidation() {
            const emailInput = document.getElementById('profileEmail');
            const firstNameInput = document.getElementById('profileFirstName');
            const lastNameInput = document.getElementById('profileLastName');
            const genderInput = document.getElementById('profileGender');
            const birthdayInput = document.getElementById('profileBirthday');
            const passwordInput = document.getElementById('profilePassword');
            const newPasswordInput = document.getElementById('profileNewPassword');
            const confirmPasswordInput = document.getElementById('profileConfirmPassword');
            
            // Email validation
            if (emailInput) {
                emailInput.addEventListener('input', () => {
                    validateProfileEmail();
                    checkProfileRequiredFields();
                });
                emailInput.addEventListener('blur', () => {
                    validateProfileEmail();
                    checkProfileRequiredFields();
                });
            }
            
            // First Name validation
            if (firstNameInput) {
                firstNameInput.addEventListener('input', () => {
                    validateProfileFirstName();
                    checkProfileRequiredFields();
                });
                firstNameInput.addEventListener('blur', () => {
                    validateProfileFirstName();
                    checkProfileRequiredFields();
                });
            }
            
            // Last Name validation
            if (lastNameInput) {
                lastNameInput.addEventListener('input', () => {
                    validateProfileLastName();
                    checkProfileRequiredFields();
                });
                lastNameInput.addEventListener('blur', () => {
                    validateProfileLastName();
                    checkProfileRequiredFields();
                });
            }
            
            // Gender validation
            if (genderInput) {
                genderInput.addEventListener('change', () => {
                    validateProfileGender();
                    checkProfileRequiredFields();
                });
            }
            
            // Birthday validation
            if (birthdayInput) {
                birthdayInput.addEventListener('input', () => {
                    validateProfileBirthday();
                    checkProfileRequiredFields();
                });
                birthdayInput.addEventListener('blur', () => {
                    validateProfileBirthday();
                    checkProfileRequiredFields();
                });
            }
            
            // Password validation
            if (passwordInput) {
                passwordInput.addEventListener('input', () => {
                    validateProfilePassword(passwordInput, 'profilePassword');
                    validatePasswordSameAsCurrent();
                    checkProfileRequiredFields();
                });
                passwordInput.addEventListener('blur', () => {
                    validateProfilePassword(passwordInput, 'profilePassword');
                    validatePasswordSameAsCurrent();
                    checkProfileRequiredFields();
                });
            }
            
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', () => {
                    validateProfilePassword(newPasswordInput, 'profileNewPassword');
                    validatePasswordSameAsCurrent();
                    checkProfileRequiredFields();
                });
                newPasswordInput.addEventListener('blur', () => {
                    validateProfilePassword(newPasswordInput, 'profileNewPassword');
                    validatePasswordSameAsCurrent();
                    checkProfileRequiredFields();
                });
            }
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', () => {
                    validateProfilePassword(confirmPasswordInput, 'profileConfirmPassword');
                    validatePasswordSameAsCurrent();
                    checkProfileRequiredFields();
                });
                confirmPasswordInput.addEventListener('blur', () => {
                    validateProfilePassword(confirmPasswordInput, 'profileConfirmPassword');
                    validatePasswordSameAsCurrent();
                    checkProfileRequiredFields();
                });
            }
        }
        
        // Close Profile Modal
        function closeProfileModal(event) {
            if (event && event.target.id !== 'profileModal' && !event.target.closest('.address-modal')) return;
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        // Get scrollbar width
        function getScrollbarWidth() {
            const outer = document.createElement('div');
            outer.style.visibility = 'hidden';
            outer.style.overflow = 'scroll';
            outer.style.msOverflowStyle = 'scrollbar';
            outer.style.width = '100px';
            outer.style.position = 'absolute';
            outer.style.top = '-9999px';
            document.body.appendChild(outer);
            const inner = document.createElement('div');
            inner.style.width = '100%';
            outer.appendChild(inner);
            const scrollbarWidth = outer.offsetWidth - inner.offsetWidth;
            outer.parentNode.removeChild(outer);
            return scrollbarWidth;
        }
        
        // Prevent body scroll while keeping scrollbar space (no layout shift)
        function lockBodyScroll() {
            // Calculate scrollbar width and add padding BEFORE hiding overflow
            const scrollbarWidth = getScrollbarWidth();
            const scrollY = window.scrollY;
            
            // Add padding to preserve scrollbar space
            document.body.style.paddingRight = scrollbarWidth + 'px';
            // Hide overflow (scrollbar disappears but space remains)
            document.body.style.overflow = 'hidden';
            
            // Store values for restoration
            document.body.dataset.scrollY = scrollY;
            document.body.dataset.scrollbarWidth = scrollbarWidth;
        }
        
        // Restore body scroll
        function unlockBodyScroll() {
            const scrollY = document.body.dataset.scrollY || 0;
            
            // Remove padding and restore overflow
            document.body.style.paddingRight = '';
            document.body.style.overflow = '';
            
            // Clean up stored values
            delete document.body.dataset.scrollY;
            delete document.body.dataset.scrollbarWidth;
            
            // Restore scroll position
            window.scrollTo(0, parseInt(scrollY) || 0);
        }
        
        // Open Settings Modal
        function openSettingsModal() {
            const modal = document.getElementById('settingsModal');
            if (!modal) return;
            
            // Lock body scroll but keep scrollbar visible
            lockBodyScroll();
            
            modal.style.display = 'flex';
        }
        
        // Close Settings Modal
        function closeSettingsModal(event) {
            if (event && event.target.id !== 'settingsModal' && !event.target.closest('.address-modal')) return;
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.style.display = 'none';
                // Unlock body scroll
                unlockBodyScroll();
            }
        }
        
        // Toggle Password Visibility
        function togglePasswordVisibility(inputId, icon) {
            const input = document.getElementById(inputId);
            if (!input || !icon) return;
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        // Profile validation functions (similar to AnemoCheck)
        const profileSuccessTimers = {};
        let isInitialProfileLoad = false; // Flag to prevent success states on initial load
        
        function markProfileSuccess(el, key) {
            if (!el) return;
            // Don't add success state on initial load
            if (isInitialProfileLoad) {
                return;
            }
            el.classList.remove('error');
            el.classList.add('success');
            if (profileSuccessTimers[key]) clearTimeout(profileSuccessTimers[key]);
            profileSuccessTimers[key] = setTimeout(() => {
                el.classList.remove('success');
            }, 3000);
        }
        
        function hideProfileErrors(idBase) {
            const errors = ['error', 'format-error', 'required', 'min', 'same', 'mismatch', 'incorrect'];
            errors.forEach(suffix => {
                const errEl = document.getElementById(idBase + '-' + suffix);
                if (errEl) errEl.style.display = 'none';
            });
        }
        
        function markProfileError(el) {
            if (el) {
                el.classList.add('error');
                el.classList.remove('success');
            }
        }
        
        function markProfileClear(el) {
            if (el) {
                el.classList.remove('error');
            }
        }
        
        // Validate Email
        function validateProfileEmail() {
            const emailInput = document.getElementById('profileEmail');
            if (!emailInput) return true;
            
            hideProfileErrors('profileEmail');
            const v = (emailInput.value || '').trim();
            
            if (!v) {
                const errEl = document.getElementById('profileEmail-error');
                if (errEl) errEl.style.display = 'block';
                markProfileError(emailInput);
                return false;
            }
            
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) {
                const errEl = document.getElementById('profileEmail-format-error');
                if (errEl) errEl.style.display = 'block';
                markProfileError(emailInput);
                return false;
            }
            
            markProfileClear(emailInput);
            markProfileSuccess(emailInput, 'email');
            return true;
        }
        
        // Validate First Name
        function validateProfileFirstName() {
            const input = document.getElementById('profileFirstName');
            if (!input) return true;
            
            const errEl = document.getElementById('profileFirstName-error');
            if (errEl) errEl.style.display = 'none';
            markProfileClear(input);
            
            const v = (input.value || '').trim();
            if (!v) {
                if (errEl) errEl.style.display = 'block';
                markProfileError(input);
                return false;
            }
            
            markProfileSuccess(input, 'firstName');
            return true;
        }
        
        // Validate Last Name
        function validateProfileLastName() {
            const input = document.getElementById('profileLastName');
            if (!input) return true;
            
            const errEl = document.getElementById('profileLastName-error');
            if (errEl) errEl.style.display = 'none';
            markProfileClear(input);
            
            const v = (input.value || '').trim();
            if (!v) {
                if (errEl) errEl.style.display = 'block';
                markProfileError(input);
                return false;
            }
            
            markProfileSuccess(input, 'lastName');
            return true;
        }
        
        // Validate Gender
        function validateProfileGender() {
            const input = document.getElementById('profileGender');
            if (!input) return true;
            
            const errEl = document.getElementById('profileGender-error');
            if (errEl) errEl.style.display = 'none';
            markProfileClear(input);
            
            if (!input.value) {
                if (errEl) errEl.style.display = 'block';
                markProfileError(input);
                return false;
            }
            
            markProfileSuccess(input, 'gender');
            return true;
        }
        
        // Validate Birthday
        function validateProfileBirthday() {
            const input = document.getElementById('profileBirthday');
            if (!input) return true;
            
            const errEl = document.getElementById('profileBirthday-error');
            if (errEl) errEl.style.display = 'none';
            markProfileClear(input);
            
            const v = (input.value || '').trim();
            if (!v) {
                if (errEl) errEl.style.display = 'block';
                markProfileError(input);
                return false;
            }
            
            // Set max date to today
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            input.max = `${yyyy}-${mm}-${dd}`;
            
            markProfileSuccess(input, 'birthday');
            return true;
        }
        
        // Check if any password field is filled
        function anyPasswordFilled() {
            const current = document.getElementById('profilePassword');
            const newPwd = document.getElementById('profileNewPassword');
            const confirm = document.getElementById('profileConfirmPassword');
            return ((current?.value || '').trim() || (newPwd?.value || '').trim() || (confirm?.value || '').trim()) ? true : false;
        }
        
        // Validate Password Field
        function validateProfilePassword(el, idBase) {
            if (!el) return true;
            hideProfileErrors(idBase);
            // Also hide incorrect password error when user types
            if (idBase === 'profilePassword') {
                const incorrectEl = document.getElementById('profilePassword-incorrect');
                if (incorrectEl) incorrectEl.style.display = 'none';
            }
            const v = (el.value || '').trim();
            const requireNow = anyPasswordFilled();
            
            if (!v) {
                if (requireNow) {
                    const req = document.getElementById(idBase + '-required');
                    if (req) req.style.display = 'block';
                    markProfileError(el);
                    return false;
                } else {
                    markProfileClear(el);
                    return true;
                }
            }
            
            if (v.length < 8) {
                const min = document.getElementById(idBase + '-min');
                if (min) min.style.display = 'block';
                markProfileError(el);
                return false;
            }
            
            markProfileClear(el);
            markProfileSuccess(el, idBase);
            return true;
        }
        
        // Validate Password Same As Current
        function validatePasswordSameAsCurrent() {
            const currentEl = document.getElementById('profilePassword');
            const newEl = document.getElementById('profileNewPassword');
            const confirmEl = document.getElementById('profileConfirmPassword');
            
            const curr = (currentEl?.value || '').trim();
            const newv = (newEl?.value || '').trim();
            const conf = (confirmEl?.value || '').trim();
            let ok = true;
            const requireNow = anyPasswordFilled();
            
            // Check if new password is same as current
            if (requireNow && curr && newv && curr === newv) {
                const same = document.getElementById('profileNewPassword-same');
                if (same) same.style.display = 'block';
                markProfileError(newEl);
                ok = false;
            } else {
                const same = document.getElementById('profileNewPassword-same');
                if (same) same.style.display = 'none';
            }
            
            // Check if confirm password is same as current
            if (requireNow && curr && conf && curr === conf) {
                const same = document.getElementById('profileConfirmPassword-same');
                if (same) same.style.display = 'block';
                markProfileError(confirmEl);
                ok = false;
            } else {
                const same = document.getElementById('profileConfirmPassword-same');
                if (same) same.style.display = 'none';
            }
            
            // Check if new and confirm match
            const mismatchEl = document.getElementById('profileConfirmPassword-mismatch');
            if (requireNow && newv && conf && newv !== conf) {
                if (mismatchEl) mismatchEl.style.display = 'block';
                markProfileError(confirmEl);
                ok = false;
            } else {
                if (mismatchEl) mismatchEl.style.display = 'none';
            }
            
            // Refresh success glow if all good
            if (ok && requireNow) {
                if ((newEl?.value || '').trim().length >= 8) markProfileSuccess(newEl, 'profileNewPassword');
                if ((confirmEl?.value || '').trim().length >= 8 && newv === conf) markProfileSuccess(confirmEl, 'profileConfirmPassword');
            }
            
            return ok;
        }
        
        // Check Required Fields and Enable/Disable Update Button
        function checkProfileRequiredFields() {
            const updateBtn = document.getElementById('updateProfileBtn');
            if (!updateBtn) return;
            
            const requiredFields = ['profileEmail', 'profileFirstName', 'profileLastName', 'profileGender', 'profileBirthday'];
            let allValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    const value = (field.value || '').trim();
                    if (!value) {
                        allValid = false;
                    }
                }
            });
            
            // Validate email format
            if (allValid) {
                allValid = validateProfileEmail();
            }
            
            // If passwords are filled, validate them
            if (allValid && anyPasswordFilled()) {
                const currentEl = document.getElementById('profilePassword');
                const newEl = document.getElementById('profileNewPassword');
                const confirmEl = document.getElementById('profileConfirmPassword');
                
                allValid = validateProfilePassword(currentEl, 'profilePassword') && allValid;
                allValid = validateProfilePassword(newEl, 'profileNewPassword') && allValid;
                allValid = validateProfilePassword(confirmEl, 'profileConfirmPassword') && allValid;
                allValid = validatePasswordSameAsCurrent() && allValid;
            }
            
            // Enable/disable button
            if (allValid) {
                updateBtn.disabled = false;
                updateBtn.style.opacity = '1';
                updateBtn.style.cursor = 'pointer';
            } else {
                updateBtn.disabled = true;
                updateBtn.style.opacity = '0.6';
                updateBtn.style.cursor = 'not-allowed';
            }
        }
        
        // Save Profile
        function saveProfile(event) {
            event.preventDefault();
            
            const updateBtn = document.getElementById('updateProfileBtn');
            if (updateBtn && updateBtn.disabled) {
                return;
            }
            
            // Validate all required fields
            let isValid = true;
            isValid = validateProfileEmail() && isValid;
            isValid = validateProfileFirstName() && isValid;
            isValid = validateProfileLastName() && isValid;
            isValid = validateProfileGender() && isValid;
            isValid = validateProfileBirthday() && isValid;
            
            // Validate passwords if any are filled
            if (anyPasswordFilled()) {
                const currentEl = document.getElementById('profilePassword');
                const newEl = document.getElementById('profileNewPassword');
                const confirmEl = document.getElementById('profileConfirmPassword');
                
                isValid = validateProfilePassword(currentEl, 'profilePassword') && isValid;
                isValid = validateProfilePassword(newEl, 'profileNewPassword') && isValid;
                isValid = validateProfilePassword(confirmEl, 'profileConfirmPassword') && isValid;
                isValid = validatePasswordSameAsCurrent() && isValid;
            }
            
            if (!isValid) {
                const firstError = document.querySelector('#profileModal .form-group.error, #profileModal input.error, #profileModal select.error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            
            const currentPassword = document.getElementById('profilePassword').value.trim();
            const newPassword = document.getElementById('profileNewPassword').value.trim();
            const confirmPassword = document.getElementById('profileConfirmPassword').value.trim();
            
            // Validate passwords if provided
            if (newPassword || confirmPassword || currentPassword) {
                if (!currentPassword) {
                    showNotification('Please enter your current password to change it', 'error');
                    return;
                }
                
                if (!newPassword) {
                    showNotification('Please enter a new password', 'error');
                    return;
                }
                
                if (newPassword.length < 8) {
                    showNotification('New password must be at least 8 characters', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showNotification('New passwords do not match', 'error');
                    return;
                }
            }
            
            // Prepare data for API
            const userData = {
                email: document.getElementById('profileEmail').value.trim(),
                firstName: document.getElementById('profileFirstName').value.trim(),
                lastName: document.getElementById('profileLastName').value.trim(),
                gender: document.getElementById('profileGender').value,
                birthday: document.getElementById('profileBirthday').value,
                first_name: document.getElementById('profileFirstName').value.trim(),
                last_name: document.getElementById('profileLastName').value.trim(),
                date_of_birth: document.getElementById('profileBirthday').value
            };
            
            // Only include password fields if provided
            if (currentPassword) {
                userData.password = currentPassword;
            }
            if (newPassword) {
                userData.newPassword = newPassword;
            }
            
            // Disable button during save
            if (updateBtn) {
                updateBtn.disabled = true;
                updateBtn.textContent = 'Saving...';
            }
            
            // Save to database via API
            fetch('api/update_profile.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Check if password was changed
                    const passwordChanged = newPassword && newPassword.length > 0;
                    
                    // Update localStorage with new data
                    const updatedUserData = {
                        username: document.getElementById('profileUsername').value.trim(),
                        email: userData.email,
                        firstName: userData.firstName,
                        lastName: userData.lastName,
                        first_name: userData.first_name,
                        last_name: userData.last_name,
                        gender: userData.gender,
                        birthday: userData.birthday,
                        date_of_birth: userData.date_of_birth
                    };
                    
                    localStorage.setItem('userData', JSON.stringify(updatedUserData));
                    localStorage.setItem('loggedInUser', JSON.stringify(updatedUserData));
                    sessionStorage.setItem('userData', JSON.stringify(updatedUserData));
                    
                    // Reload user data to update navbar
                    loadUserData();
                    
                    // Close modal
                    closeProfileModal();
                    
                    if (passwordChanged) {
                        // Show message about password change requiring re-login
                        showNotification('Password changed successfully! For security reasons, please log in again with your new password.', 'success');
                        
                        // Wait a moment for the notification to be seen, then logout
                        setTimeout(() => {
                            // Clear user session data
                            localStorage.removeItem('loggedInUser');
                            sessionStorage.removeItem('userData');
                            
                            // Redirect to login page
                            window.location.href = 'login.html';
                        }, 2000);
                    } else {
                        // Show success message for regular profile update
                        showNotification('Profile updated successfully!', 'success');
                    }
                } else {
                    // Show error messages
                    if (data.errors) {
                        Object.keys(data.errors).forEach(field => {
                            const errorMsg = data.errors[field];
                            
                            // Handle password error specifically - show inline below the field
                            if (field === 'password' && errorMsg.includes('incorrect')) {
                                const errorEl = document.getElementById('profilePassword-incorrect');
                                if (errorEl) {
                                    errorEl.style.display = 'block';
                                    const passwordInput = document.getElementById('profilePassword');
                                    if (passwordInput) {
                                        markProfileError(passwordInput);
                                        const formGroup = passwordInput.closest('.form-group');
                                        if (formGroup) {
                                            formGroup.classList.add('error');
                                        }
                                    }
                                }
                            } else {
                                // For other errors, show notification
                                showNotification(errorMsg, 'error');
                            }
                        });
                    } else {
                        showNotification(data.message || 'Failed to update profile. Please try again.', 'error');
                    }
                    
                    // Re-enable button
                    if (updateBtn) {
                        updateBtn.disabled = false;
                        updateBtn.textContent = 'Save Changes';
                    }
                }
            })
            .catch(error => {
                console.error('Error updating profile:', error);
                showNotification('An error occurred while updating your profile. Please try again.', 'error');
                
                // Re-enable button
                if (updateBtn) {
                    updateBtn.disabled = false;
                    updateBtn.textContent = 'Save Changes';
                }
            });
        }
        
        // Show Logout Confirmation Modal
        function showLogoutConfirmModal() {
            const modal = document.getElementById('logoutConfirmModal');
            const confirmBtn = document.getElementById('logoutConfirmBtn');
            const cancelBtn = document.getElementById('logoutCancelBtn');
            
            if (!modal) return;
            
            // Lock body scroll but keep scrollbar visible
            lockBodyScroll();
            
            modal.style.display = 'flex';
            
            // Remove existing event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            const newCancelBtn = cancelBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            
            // Add new event listeners
            newConfirmBtn.addEventListener('click', function confirmHandler() {
                modal.style.display = 'none';
                unlockBodyScroll();
                performLogout();
                newConfirmBtn.removeEventListener('click', confirmHandler);
            });
            
            newCancelBtn.addEventListener('click', function cancelHandler() {
                modal.style.display = 'none';
                unlockBodyScroll();
                newCancelBtn.removeEventListener('click', cancelHandler);
            });
        }
        
        // Perform Logout
        function performLogout() {
            // Clear user session data
            localStorage.removeItem('loggedInUser');
            sessionStorage.removeItem('userData');
            // Optionally clear cart and other user-specific data
            // localStorage.removeItem('cart');
            // localStorage.removeItem('deliveryAddress');
            
            window.location.href = 'index.html';
        }
        
        // Logout
        function logout() {
            showLogoutConfirmModal();
        }
        
        // Initialize
        loadCart();
        loadAddress();
        initializeLocationDropdowns();
        
        // Navbar scroll effect (only shadow, no size changes)
        window.addEventListener('scroll', function() {
            const navbar = document.querySelector('.navbar');
            if (window.scrollY > 50) {
                navbar.style.boxShadow = '0 4px 30px rgba(0, 0, 0, 0.15)';
            } else {
                navbar.style.boxShadow = '0 2px 20px rgba(0, 0, 0, 0.1)';
            }
        });
        
        // Navbar styling is handled by navbar.css - no JavaScript manipulation needed
    </script>
    
    <!-- Footer -->
    <footer id="contact" class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <h4 class="footer-title" style="display: flex; align-items: center;">
                        <img src="systemlogo.png" alt="AquaSphere Logo" style="height: 40px; margin-right: 10px;">
                        AquaSphere
                    </h4>
                    <p style="color: rgba(255, 255, 255, 0.8); line-height: 1.7;">
                        Your trusted water delivery service. Fast delivery, clean quality water, and reliable service. 
                        Everything you need for your hydration needs, all in one platform.
                    </p>
                </div>
                
                <div class="col-lg-2 col-md-6 mb-4">
                    <h5 class="footer-title">Quick Links</h5>
                    <a href="index.html" class="footer-link">Home</a>
                    <a href="#features" class="footer-link">Features</a>
                    <a href="#how-it-works" class="footer-link">How It Works</a>
                    <a href="#contact" class="footer-link">Contact</a>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <h5 class="footer-title">Features</h5>
                    <a href="#" class="footer-link">Easy Ordering</a>
                    <a href="#" class="footer-link">Delivery Tracking</a>
                    <a href="#" class="footer-link">Payment Options</a>
                    <a href="#" class="footer-link">Customer Support</a>
                </div>
                
                <div class="col-lg-3 mb-4">
                    <h5 class="footer-title">Connect With Us</h5>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                    <p class="mt-1" style="color: rgba(255, 255, 255, 0.8);">
                        <i class="fas fa-envelope me-2"></i>support@aquasphere.com
                    </p>
                </div>
            </div>
            
            <hr style="border-color: rgba(255, 255, 255, 0.2); margin: 1rem 0 0.8rem;">
            
            <div class="text-center" style="color: rgba(255, 255, 255, 0.8); font-size: 0.8rem;">
                <p>&copy; 2024 AquaSphere. Made with ‚ù§Ô∏è for clean water delivery. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>

